<!DOCTYPE html>
<html>

	<head>
		
<title>Linux性能工具使用-Junixcn</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" type="image/x-icon" href="/image/favicon.ico">

<meta name="keywords" content="Notes">
<meta name="description" content="描述">


<script src="/js/jquery.min.js"></script>



<!-- Baidu Analytics -->
<script defer>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?4b5fe1472f22fa";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>


	<meta name="generator" content="Hexo 5.2.0"></head>

	<body>
		
<link rel="stylesheet" href="/css/page.css">


<link rel="stylesheet" href="/css/page_cente.css">


<link rel="stylesheet" href="/css/atom-one-dark.css">


<link rel="stylesheet" href="/css/header.css">

<div class="header">
	<div class="header-top">
		<div class="h-left">
			<a href="/">
				<img src="/image/logo.png" alt="">
			</a>
		</div>
		<div class="h-right">
			<ul>
				
				
				<li>
					<a href="/">主页</a>
					<span class="dot"></span>
				</li>
				
				
				
				<li>
					<a href="/archives">列表</a>
					<span class="dot"></span>
				</li>
				
				
				
				<li>
					<a href="/categories">分类</a>
					<span class="dot"></span>
				</li>
				
				
				
				<li>
					<a href="/tags">标签</a>
					<span class="dot"></span>
				</li>
				
				
				
				<li>
					<a href="/links">链接</a>
					<span class="dot"></span>
				</li>
				
				
				
				<li>
					<a href="/about">关于</a>
					<span class="dot"></span>
				</li>
				
				
			</ul>
		</div>
		<div class="h-right-close">
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
				<path fill="none" d="M0 0h24v24H0z" />
				<path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z" fill="rgba(68,68,68,1)" />
			</svg>
		</div>
	</div>
</div>
<div class="sidebar">
    <div class="topo">
        <h2>Junixcn</h2>
    </div>
    <ul>
        
        <li>
            <a href="/">主页</a>
        </li>
        
        <li>
            <a href="/archives">列表</a>
        </li>
        
        <li>
            <a href="/categories">分类</a>
        </li>
        
        <li>
            <a href="/tags">标签</a>
        </li>
        
        <li>
            <a href="/links">链接</a>
        </li>
        
        <li>
            <a href="/about">关于</a>
        </li>
        
    </ul>
    <div class="my_foot">
        
        <a target="_blank" rel="noopener" href="https://github.com/junixcn">
            <img src="/image/github-logo.png" alt="Quiet主题">
        </a>
        
    </div>
</div>
<div class='shelter'
    style='cursor: pointer;display: none; position: fixed;left: 0;top: 0; right: 0;bottom: 0;background-color: #333;opacity:0.5;z-index: 108;'>
</div>
<style>
    .sidebar {
        width: 0;
        height: 100%;
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        background: #fff;
        z-index: 999;
        text-align: center;
        box-shadow: -6px 0 20px rgba(98, 94, 94, .815)
    }

    .topo {
        width: 100%;
        height: 200px;
        background: url(https://api.ixiaowai.cn/gqapi/gqapi.php) no-repeat;
        background-size: 100% 100%;
        position: relative;
        display: flex;
        align-items: flex-end
    }

    .topo h2 {
        color: #fff;
        z-index: 1;
        position: relative;
        margin: 0 0 10px 10px;
        font-size: 1.2em;
        box-sizing: border-box
    }

    .topo:before {
        content: '';
        background-image: url(/image/pattern.png);
        background-repeat: repeat;
        height: 100%;
        left: 0;
        position: absolute;
        top: 0;
        width: 100%;
        z-index: 1
    }

    .sidebar ul {
        width: 100%;
        margin-top: 50px
    }

    .sidebar ul li {
        height: 50px;
        list-style: none;
        font-size: 1.2em;
        text-align: right;
        margin-right: 10px
    }

    .sidebar ul li a {
        display: grid;
        color: #5d606a;
        text-overflow: ellipsis;
        width: 100%;
        text-decoration: none
    }

    .my_foot {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        position: absolute;
        bottom: 0
    }

    .my_foot a {
        text-decoration: none;
        margin-right: 10px;
        display: inline-block
    }

    .my_foot a img {
        width: 30px;
        height: 30px
    }
</style>

<script>
    $(function () { $('.h-right-close>svg').click(function () { $('.sidebar').animate({ width: "66%" }, 500); $('.shelter').fadeIn("slow") }); $('.shelter').click(function (e) { $('.sidebar').animate({ width: "0" }, 500); $('.shelter').fadeOut("slow") }) })
</script>
<script>
	$(function () { $(window).scroll(function () { if ($(document).scrollTop() > 100) { $(".header-top").removeClass("header-move2"); $('.header-top').addClass('header-move1') } else { $(".header-top").removeClass("header-move1"); $('.header-top').addClass('header-move2') } }) });
</script>
<div class="header-bg bg-content-img">
    <div class="bg-content">
        <ul class="tag">
            
        </ul>
        <h1>Linux性能工具使用</h1>
        <div class="article-info">
            <div class="article-author">
                
                <svg t="1604839279282" class="icon" viewBox="0 0 1024 1024" version="1.1"
                    xmlns="http://www.w3.org/2000/svg" p-id="2901" width="20" height="20">
                    <path
                        d="M513 956.3c-247.7 0-448-200.3-448-448S265.3 66.2 513 66.2s448 200.3 448 448-200.3 442.1-448 442.1z m0-830.9c-212.2 0-388.8 170.7-388.8 388.8C124.2 726.3 294.9 903 513 903c212.2 0 388.8-170.7 388.8-388.8S725.2 125.4 513 125.4z m0 430.2c-94.2 0-170.7-76.5-170.7-170.7S418.8 207.8 513 207.8s170.7 76.5 170.7 170.7S607.2 555.6 513 555.6z m0-289.1c-64.6 0-112 52.8-112 112s47.4 117.9 112 117.9 112-52.8 112-112-47.4-117.9-112-117.9z m0 689.8c-135.7 0-259-58.7-341.9-158.9l-11.8-17.8 11.8-17.8c76.5-117.9 206.2-188.5 347.8-188.5 135.7 0 265 64.6 341.9 182.6l11.8 17.8-11.8 17.8C778 897.1 648.7 956.3 513 956.3zM230.3 773.2C300.9 849.7 406.9 897 513 897c112 0 218.1-47.4 288.6-129.8-70.5-88.2-170.7-135.6-282.7-135.6s-218.1 53.3-288.6 141.6z"
                        p-id="2902" fill="#ffffff"></path>
                </svg>
                
                <span> <a href="">Junixcn</a></span>
                <p>2021-01-06 18:08:08</p>
            </div>
        </div>
    </div>
</div>
<div class="article-content">
    <div id="article" class="content">
        <h2 id="Linux-performance-tools-samples"><a href="#Linux-performance-tools-samples" class="headerlink" title="Linux performance tools samples"></a>Linux performance tools samples</h2><h3 id="0-基础工具"><a href="#0-基础工具" class="headerlink" title="0. 基础工具"></a>0. 基础工具</h3><h4 id="0-1-top"><a href="#0-1-top" class="headerlink" title="0.1 top"></a>0.1 top</h4><h4 id="0-2-htop"><a href="#0-2-htop" class="headerlink" title="0.2 htop"></a>0.2 htop</h4><p><img src="https://raw.githubusercontent.com/junixcn/images/master/image-20210106152827692.png" alt="image-20210106152827692"></p>
<h4 id="0-3-ps"><a href="#0-3-ps" class="headerlink" title="0.3 ps"></a>0.3 ps</h4><h4 id="0-4-sar"><a href="#0-4-sar" class="headerlink" title="0.4 sar"></a>0.4 sar</h4><p>这个sar工具到是CPU/memory/file-system/disk都能用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# sar</span><br><span class="line">Linux 4.18.0-147.8.1.el8_1.x86_64 (localhost.localdomain)       01/06/2021      _x86_64_        (56 CPU)</span><br><span class="line"></span><br><span class="line">12:00:14 AM     CPU     %user     %nice   %system   %iowait    %steal     %idle</span><br><span class="line">12:10:14 AM     all      1.53      0.00      1.60      0.02      0.00     96.86</span><br><span class="line">12:20:14 AM     all      1.39      0.00      1.56      0.02      0.00     97.02</span><br><span class="line">12:30:11 AM     all      1.37      0.00      1.56      0.01      0.00     97.06</span><br><span class="line">12:40:14 AM     all      2.80      0.00      2.02      0.01      0.00     95.17</span><br><span class="line">12:50:14 AM     all      4.24      0.00      2.53      0.01      0.00     93.22</span><br><span class="line">01:00:00 AM     all      4.19      0.00      2.53      0.01      0.00     93.27</span><br><span class="line">01:10:14 AM     all      4.07      0.00      2.54      0.02      0.00     93.37</span><br><span class="line">01:20:14 AM     all      4.06      0.00      2.55      0.03      0.00     93.37</span><br><span class="line">01:30:14 AM     all      4.55      0.00      2.58      0.03      0.00     92.83</span><br><span class="line">01:40:14 AM     all      4.47      0.00      2.48      0.04      0.00     93.00</span><br><span class="line">01:50:14 AM     all      3.93      0.00      2.40      0.02      0.00     93.66</span><br><span class="line">02:00:14 AM     all      5.06      0.00      2.95      0.35      0.00     91.64</span><br><span class="line">02:10:14 AM     all      2.64      0.00      2.08      0.03      0.00     95.26</span><br><span class="line">02:20:14 AM     all      3.95      0.00      2.46      0.02      0.00     93.57</span><br><span class="line">Average:        all      3.45      0.00      2.27      0.04      0.00     94.24</span><br></pre></td></tr></table></figure>



<h3 id="1-CPUs"><a href="#1-CPUs" class="headerlink" title="1. CPUs"></a>1. CPUs</h3><h4 id="1-1-uptime"><a href="#1-1-uptime" class="headerlink" title="1.1 uptime"></a>1.1 uptime</h4><p><img src="https://raw.githubusercontent.com/junixcn/images/master/load-average.png" alt="load-average"></p>
<p>Load averages 的三个值分别代表最近 1/5/15 分钟的平均系统负载。在多核系统中，这些值有可能经常大于1，比如四核系统的 100% 负载为 4，八核系统的 100% 负载为 8。</p>
<p>Loadavg 有它固有的一些缺陷：</p>
<ul>
<li>uninterruptible的进程，无法区分它是在等待 CPU 还是 IO。无法精确评估单个资源的竞争程度；</li>
<li>最短的时间粒度是 1 分钟，以 5 秒间隔采样。很难精细化管理资源竞争毛刺和短期过度使用；</li>
<li>结果以进程数量呈现，还要结合 cpu 数量运算，很难直观判断当前系统资源是否紧张，是否影响任务吞吐量</li>
</ul>
<p><strong>PSI - Pressure Stall Information</strong></p>
<p>每类资源的压力信息都通过 proc 文件系统的独立文件来提供，路径为 /proc/pressure/ – cpu, memory, and io.</p>
<p>其中 CPU 压力信息格式如下：</p>
<p>some avg10=2.98 avg60=2.81 avg300=1.41 total=268109926</p>
<p>memory 和 io 格式如下：</p>
<p>some avg10=0.30 avg60=0.12 avg300=0.02 total=4170757</p>
<p>full avg10=0.12 avg60=0.05 avg300=0.01 total=1856503</p>
<p><strong>avg10、avg60、avg300 分别代表 10s、60s、300s 的时间周期内的阻塞时间百分比</strong>。total 是总累计时间，以毫秒为单位。</p>
<p><strong>some 这一行，代表至少有一个任务在某个资源上阻塞的时间占比，full 这一行，代表所有的非idle任务同时被阻塞的时间占比，这期间 cpu 被完全浪费，会带来严重的性能问题</strong>。我们以 IO 的 some 和 full 来举例说明，假设在 60 秒的时间段内，系统有两个 task，在 60 秒的周期内的运行情况如下图所示：</p>
<p><img src="https://raw.githubusercontent.com/junixcn/images/master/image-20201230105704128.png" alt="image-20201230105704128"></p>
<p>红色阴影部分表示任务由于等待 IO 资源而进入阻塞状态。Task A 和 Task B 同时阻塞的部分为 full，占比 16.66%；至少有一个任务阻塞（仅 Task B 阻塞的部分也计算入内）的部分为 some，占比 50%。</p>
<p>some 和 full 都是在某一时间段内阻塞时间占比的总和，阻塞时间不一定连续，如下图所示：</p>
<p><img src="https://raw.githubusercontent.com/junixcn/images/master/image-20201230105720099.png" alt="image-20201230105720099"></p>
<p>IO 和 memory 都有 some 和 full 两个维度，那是因为的确有可能系统中的所有任务都阻塞在 IO 或者 memory 资源，同时 CPU 进入 idle 状态。</p>
<p>但是 CPU 资源不可能出现这个情况：不可能全部的 runnable 的任务都等待 CPU 资源，至少有一个 runnable 任务会被调度器选中占有 CPU 资源，因此 CPU 资源没有 full 维度的 PSI 信息呈现。</p>
<p>通过这些阻塞占比数据，我们可以看到短期以及中长期一段时间内各种资源的压力情况，可以较精确的确定时延抖动原因，并制定对应的负载管理策略。</p>
<h4 id="1-2-vmstat"><a href="#1-2-vmstat" class="headerlink" title="1.2 vmstat"></a>1.2 vmstat</h4><p>显示虚拟内存使用情况的工具</p>
<p>用法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Usage:</span><br><span class="line"> vmstat [options] [delay [count]]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line"> -a, --active           active/inactive memory</span><br><span class="line"> -f, --forks            number of forks since boot</span><br><span class="line"> -m, --slabs            slabinfo</span><br><span class="line"> -n, --one-header       do not redisplay header</span><br><span class="line"> -s, --stats            event counter statistics</span><br><span class="line"> -d, --disk             disk statistics</span><br><span class="line"> -D, --disk-sum         summarize disk statistics</span><br><span class="line"> -p, --partition &lt;dev&gt;  partition specific statistics</span><br><span class="line"> -S, --unit &lt;char&gt;      define display unit   #设置显示数值的单位（k,K,m,M)</span><br><span class="line"> -w, --wide             wide output</span><br><span class="line"> -t, --timestamp        show timestamp</span><br><span class="line"></span><br><span class="line"> -h, --help     display this help and exit</span><br><span class="line"> -V, --version  output version information and exit</span><br><span class="line"></span><br><span class="line">For more details see vmstat(8).</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost /]# vmstat -Sm 1 2</span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st</span><br><span class="line"> 3  0   2269  71344    341  56880    0    0    77    48    1    1  4  2 93  1  0</span><br><span class="line"> 3  0   2269  71343    341  56880    0    0     0    24 29804 37752  4  2 94  0  0</span><br></pre></td></tr></table></figure>

<p>默认是KiB为单位，可以通过参数-SM来指定以MB为单位显示。</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>r</td>
<td>The number of runnable processes (running or waiting for run time).</td>
<td>procs</td>
</tr>
<tr>
<td>b</td>
<td>The number of processes in uninterruptible sleep.</td>
<td></td>
</tr>
<tr>
<td>swpd</td>
<td>the amount of virtual memory used.</td>
<td>memory</td>
</tr>
<tr>
<td>free</td>
<td>the amount of idle memory.</td>
<td></td>
</tr>
<tr>
<td>buff</td>
<td>the amount of memory used as buffers.</td>
<td></td>
</tr>
<tr>
<td>cache</td>
<td>the amount of memory used as cache.</td>
<td></td>
</tr>
<tr>
<td>active</td>
<td>the amount of active memory.  (-a option)</td>
<td></td>
</tr>
<tr>
<td>inactive</td>
<td>the amount of inactive memory.  (-a option)</td>
<td></td>
</tr>
<tr>
<td>si</td>
<td>Amount of memory swapped in from disk (/s).</td>
<td>swap</td>
</tr>
<tr>
<td>so</td>
<td>Amount of memory swapped to disk (/s).</td>
<td></td>
</tr>
<tr>
<td>bi</td>
<td>Blocks received from a block device (blocks/s).</td>
<td>io</td>
</tr>
<tr>
<td>bo</td>
<td>Blocks sent to a block device (blocks/s).</td>
<td></td>
</tr>
<tr>
<td>in</td>
<td>The number of interrupts per second, including the clock.</td>
<td>system</td>
</tr>
<tr>
<td>cs</td>
<td>The number of context switches per second.</td>
<td></td>
</tr>
<tr>
<td><strong>us</strong></td>
<td>Time spent running non-kernel code.  (user time, including nice time)</td>
<td><strong>cpu</strong><br />(以下都是占cpu time的百分比值)</td>
</tr>
<tr>
<td><strong>sy</strong></td>
<td>Time spent running kernel code.  (system time)</td>
<td></td>
</tr>
<tr>
<td><strong>id</strong></td>
<td>Time spent idle.</td>
<td></td>
</tr>
<tr>
<td><strong>wa</strong></td>
<td>Time spent waiting for IO.</td>
<td></td>
</tr>
<tr>
<td><strong>st</strong></td>
<td>Time stolen from a virtual machine.</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="1-3-mpstat"><a href="#1-3-mpstat" class="headerlink" title="1.3 mpstat"></a>1.3 mpstat</h4><p>查看处理器的活动状态，依赖<code>/proc/stat</code>文件</p>
<p><img src="https://raw.githubusercontent.com/junixcn/images/master/image-20201230151900613.png" alt="image-20201230151900613"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">CPU： Processor number. The keyword all indicates that statistics are calculated as averages among all processors.</span><br><span class="line"></span><br><span class="line"><span class="meta">%</span><span class="bash">usr： Show the percentage of CPU utilization that occurred <span class="keyword">while</span> executing at the user level (application).</span></span><br><span class="line"></span><br><span class="line"><span class="meta">%</span><span class="bash">nice： Show the percentage of CPU utilization that occurred <span class="keyword">while</span> executing at the user level with nice priority.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">%</span><span class="bash">sys： Show  the  percentage  of CPU utilization that occurred <span class="keyword">while</span> executing at the system level (kernel). Note that this does not include time spent servicing hardware and software interrupts.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">%</span><span class="bash">iowait： Show the percentage of time that the CPU or CPUs were idle during <span class="built_in">which</span> the system had an outstanding disk I/O request.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">%</span><span class="bash">irq： Show the percentage of time spent by the CPU or CPUs to service hardware interrupts.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">%</span><span class="bash">soft： Show the percentage of time spent by the CPU or CPUs to service software interrupts.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">%</span><span class="bash">steal： Show the percentage of time spent <span class="keyword">in</span> involuntary <span class="built_in">wait</span> by the virtual CPU or CPUs <span class="keyword">while</span> the hypervisor was servicing another virtual processor.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">%</span><span class="bash">guest： Show the percentage of time spent by the CPU or CPUs to run a virtual processor.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">%</span><span class="bash">gnice： Show the percentage of time spent by the CPU or CPUs to run a niced guest.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">%</span><span class="bash">idle： Show the percentage of time that the CPU or CPUs were idle and the system did not have an outstanding disk I/O request.</span></span><br></pre></td></tr></table></figure>



<h4 id="1-4-pidstat"><a href="#1-4-pidstat" class="headerlink" title="1.4 pidstat"></a>1.4 pidstat</h4><p>pidstat用来显示系统的活动的进程信息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 比如每隔2秒、总共3次的显示page fault和内存使用情况</span></span><br><span class="line">root@ubuntu:~# pidstat -r 2 3</span><br><span class="line">Linux 5.4.0-58-generic (ubuntu) 	2021年01月05日 	_x86_64_	(2 CPU)</span><br><span class="line"></span><br><span class="line">11时38分43秒   UID       PID  minflt/s  majflt/s     VSZ     RSS   %MEM  Command</span><br><span class="line">11时38分45秒     0     21733    799.00      0.00   20864    8360   0.42  pidstat</span><br><span class="line"></span><br><span class="line">11时38分45秒   UID       PID  minflt/s  majflt/s     VSZ     RSS   %MEM  Command</span><br><span class="line">11时38分47秒  1000      1777      0.50      0.00 3918948  178616   8.90  gnome-shell</span><br><span class="line">11时38分47秒  1000      2064      8.50      0.00    2608    1524   0.08  bd-qimpanel.wat</span><br><span class="line">11时38分47秒  1000      2135    185.00      0.00  412584   32120   1.60  sogouImeService</span><br><span class="line">11时38分47秒     0     21733     52.50      0.00   20864    8888   0.44  pidstat</span><br><span class="line">11时38分47秒  1000     21741     42.50      0.00   11152     516   0.03  sleep</span><br><span class="line"></span><br><span class="line">11时38分47秒   UID       PID  minflt/s  majflt/s     VSZ     RSS   %MEM  Command</span><br><span class="line">11时38分49秒     0       355      0.50      0.00   62488   20988   1.05  systemd-journal</span><br><span class="line">11时38分49秒  1000      2064      8.50      0.00    2608    1524   0.08  bd-qimpanel.wat</span><br><span class="line">11时38分49秒  1000      2135    188.50      0.00  412584   32120   1.60  sogouImeService</span><br><span class="line">11时38分49秒     0     21733      1.50      0.00   20864    8888   0.44  pidstat</span><br><span class="line">11时38分49秒  1000     21749     42.50      0.00   11152     580   0.03  sleep</span><br><span class="line"></span><br><span class="line">Average:      UID       PID  minflt/s  majflt/s     VSZ     RSS   %MEM  Command</span><br><span class="line">Average:        0       355      0.17      0.00   62488   20988   1.05  systemd-journal</span><br><span class="line">Average:     1000      1777      0.17      0.00 3918948  178616   8.90  gnome-shell</span><br><span class="line">Average:     1000      2064      5.66      0.00    2608    1524   0.08  bd-qimpanel.wat</span><br><span class="line">Average:     1000      2135    124.29      0.00  412584   32120   1.60  sogouImeService</span><br><span class="line">Average:        0     21733    285.19      0.00   20864    8712   0.43  pidstat</span><br><span class="line">Average:     1000     21749     14.14      0.00   11152     580   0.03  sleep</span><br></pre></td></tr></table></figure>



<h4 id="1-5-turbostat"><a href="#1-5-turbostat" class="headerlink" title="1.5 turbostat"></a>1.5 turbostat</h4><p>turbostat - Report processor frequency and idle statistics.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reports processor topology, frequency, idle power-state statistics, temperature and power on X86 processors.  There are two ways to invoke turbostat.  The first method is to supply a command, which is forked and statistics are printed in one-shot upon its completion.  The second method is to omit the command, and turbostat displays statistics every 5 seconds interval.  The 5-second interval can be changed using the --interval option.</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Core</strong><br>處理器核心編號.</li>
<li><strong>CPU</strong><br>CPU邏輯處理器號碼,0,1 代表 CPU 的邏輯處理器號碼, – 代表所有處理器的總合. .</li>
<li><strong>Package</strong><br>processor package number??</li>
<li><strong>Avg_MHz</strong><br>CPU 平均工作頻率.</li>
<li><strong>Busy%</strong><br>CPU 在 C0 (Operating State) 狀態的平均時間百分比,關於 CPU C State 請參考 <a target="_blank" rel="noopener" href="http://benjr.tw/99146">http://benjr.tw/99146</a> .</li>
<li><strong>Bzy_MHz</strong><br>CPU 在 C0 (Operating State) 狀態的平均工作頻率 P stat.</li>
<li><strong>TSC_MHz</strong><br>處理器最高的運行速度(不包含 Turbo Mode).</li>
<li><strong>IRQ</strong><br>在測量間隔期間由該 CPU 提供服務的中斷 Interrupt Request (IRQ) 數量.</li>
<li><strong>SMI</strong><br>在測量間隔期間由 CPU 提供服務的系統管理中斷 system management interrupt (SMI) 數量.</li>
<li><strong>C1 , C3 , C6 , C7</strong><br>在測量間隔期間請求 C1 (Halt), C3 (Sleep) , C6 (Deep Power Down) , C7 (C6 + LLC may be flushed ) 等狀態的次數,.</li>
<li><strong>C1% , C3% , C6%, C7%</strong><br>在測量間隔期間請求 C1 (Halt), C3 (Sleep) , C6 (Deep Power Down) , C7 (C6 + LLC may be flushed ) 等狀態的百分比.</li>
<li><strong>CPU%c1, CPU%c3, CPU%c6, CPU%c7</strong><br>在測量間隔期間請求 C1 (Halt), C3 (Sleep) , C6 (Deep Power Down) , C7 (C6 + LLC may be flushed ) 等狀態的百分比.</li>
<li><strong>CoreTmp</strong><br>CPU 核心 Core 溫度感測器回傳的溫度值.</li>
<li><strong>PkgTtmp</strong><br>CPU Package 溫度感測器回傳的溫度值.</li>
<li><strong>GFX%rc6</strong><br>在測量間隔期間 GPU 處於 render C6 (rc6) 狀態的時間百分比.</li>
<li><strong>GFXMHz</strong><br>測量間隔 GPU 工作頻率.</li>
<li><strong>Pkg%pc2, Pkg%pc3, Pkg%pc6, Pkg%pc7?</strong></li>
<li><strong>PkgWatt</strong><br>CPU package 消耗的瓦特數.</li>
<li><strong>CorWatt</strong><br>CPU Core 消耗的瓦特數.</li>
<li><strong>GFXWatt</strong><br>GPU 消耗的瓦特數.</li>
<li><strong>RAMWatt</strong><br>DRAM DIMM 消耗的瓦特數.</li>
<li><strong>PKG_%</strong><br>CPU Package 處於 Running Average Power Limit (RAPL) 活動狀態的時間百分比.</li>
<li><strong>RAM_%</strong><br>DRAM 處於 Running Average Power Limit (RAPL) 活動狀態的時間百分比.</li>
</ul>
<p><img src="https://raw.githubusercontent.com/junixcn/images/master/image-20210105114551948.png" alt="image-20210105114551948"></p>
<h4 id="1-6-perf"><a href="#1-6-perf" class="headerlink" title="1.6 perf"></a>1.6 perf</h4><p>perf分析CPU的常用命令：</p>
<p><strong>采样：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">perf record -F 99 [command]  # 运行执行命令command并以99Hz的频率对on-CPU函数进行采样</span><br><span class="line">perf record -F 99 -a -g -- sleep 10 # 全局的CPU栈函数跟踪，采样保持10秒</span><br><span class="line">perf record -F 99 -p PID --call-graph dwarf -- sleep 10 # 对指定pid进程进行函数栈追踪，以dwarf模式记录10秒，采样频率99Hz</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">perf record -e sched:sched_process_exec -a # 使用exec产生的新进程事件记录</span><br><span class="line">perf record -e sched:sched_switch -a -g -- sleep 10 # 记录上下文切换事件10秒，全局范围内all cpu， -g模式使用 fp mode</span><br></pre></td></tr></table></figure>

<p>选项<code>--call-graph</code>表示调用图/调用链的集合，即样本的函数堆栈。</p>
<p>默认的<code>fp</code>使用框架指针。这非常有效，但可能不可靠，尤其是对于优化的代码。通过显式使用<code>-fno-omit-frame-pointer</code>，可以确保该代码可用于您的代码。但是，库的结果可能会有所不同。</p>
<p>使用<code>dwarf</code>，<code>perf</code>实际上收集并存储堆栈内存本身的一部分，并通过后处理对其进行展开。这可能非常消耗资源，并且堆栈深度可能有限。默认堆栈内存块为8 kiB，但可以配置。<br><code>lbr</code>代表最后一个分支记录。这是Intel CPU支持的硬件机制。这可能会以可移植性为代价提供最佳性能。 <code>lbr</code>也仅限于用户空间功能。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">perf record -e migrations -a -- sleep 10 # 采样cpu迁移事件10秒</span><br><span class="line">perf record -e migrations -a -c 1 -- sleep 10 # 每隔1秒进行cpu迁移事件采样，共10秒</span><br></pre></td></tr></table></figure>



<p><strong>读取：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">perf report -n --stdio # 读取perf.data并显示百分比等</span><br><span class="line">perf script --header # 显示perf.data的所有事件的数据头</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">### 显示5秒之内全局范围内的PMC统计数据</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> perf <span class="built_in">stat</span> -a -- sleep 5</span></span><br><span class="line"></span><br><span class="line"> Performance counter stats for &#x27;system wide&#x27;:</span><br><span class="line"></span><br><span class="line">         10,003.37 msec cpu-clock                 #    2.000 CPUs utilized          </span><br><span class="line">             1,368      context-switches          #    0.137 K/sec                  </span><br><span class="line">                71      cpu-migrations            #    0.007 K/sec                  </span><br><span class="line">             1,630      page-faults               #    0.163 K/sec                  </span><br><span class="line">   &lt;not supported&gt;      cycles                                                      </span><br><span class="line">   &lt;not supported&gt;      instructions                                                </span><br><span class="line">   &lt;not supported&gt;      branches                                                    </span><br><span class="line">   &lt;not supported&gt;      branch-misses                                               </span><br><span class="line"></span><br><span class="line">       5.001731126 seconds time elapsed</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 报告执行指定command时，CPU的最后一级缓存统计数据</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> perf <span class="built_in">stat</span> -e LLC-loads,LLC-load-misses,LLC-stores,LLC-prefetches ls &gt; /dev/null</span></span><br><span class="line"></span><br><span class="line"> Performance counter stats for &#x27;ls&#x27;:</span><br><span class="line"></span><br><span class="line">            14,161      LLC-loads                                                     (39.48%)</span><br><span class="line">             4,918      LLC-load-misses           #   34.73% of all LL-cache hits</span><br><span class="line">             1,283      LLC-stores                                                    (60.52%)</span><br><span class="line">   &lt;not supported&gt;      LLC-prefetches</span><br><span class="line"></span><br><span class="line">       0.001654001 seconds time elapsed</span><br><span class="line"></span><br><span class="line">       0.000000000 seconds user</span><br><span class="line">       0.001696000 seconds sys</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">perf stat -e sched:sched_switch -a -I 1000 # 每1秒显示上下文切换的数量</span><br><span class="line">perf stat -e sched:sched_switch --filter &#x27;prev_state == 0&#x27; -a -I 1000 # 显示被迫上下文切换的数量/s</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">perf stat -e cpu_clk_unhalted.ring0_trans,cs -a -I 1000 # 每秒的用户态切换到内核态、上下文切换</span><br><span class="line">root@ubuntu:test# perf stat -e cpu_clk_unhalted.ring0_trans,cs -a -I 1000</span><br><span class="line"><span class="meta">#</span><span class="bash">           time             counts unit events</span></span><br><span class="line">     1.000184371         98,833,364      cpu_clk_unhalted.ring0_trans                                   </span><br><span class="line">     1.000184371                347      cs                                                          </span><br><span class="line">     2.001406221         70,411,999      cpu_clk_unhalted.ring0_trans                                   </span><br><span class="line">     2.001406221                347      cs                                                          </span><br><span class="line">     3.002688296        135,797,048      cpu_clk_unhalted.ring0_trans                                   </span><br><span class="line">     3.002688296                658      cs</span><br><span class="line">     [...]</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">perf sched record -- sleep 10  # 采样10秒有关调度器的数据样本分析文件</span><br><span class="line">perf sched latency # 分析上面记录文件中的每个处理器的调度延时</span><br><span class="line">perf sched timehist # 分析上面记录文件中的每个事件调度延时</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/junixcn/images/master/image-20210105153525772.png" alt="image-20210105153525772"></p>
<p><strong>CPU火焰图</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test# perf record -F 99 -a --call-graph dwarf ./t1 </span><br><span class="line">^C[ perf record: Woken up 12 times to write data ]</span><br><span class="line">[ perf record: Captured and wrote 7.490 MB perf.data (735 samples) ]</span><br><span class="line"></span><br><span class="line">root@ubuntu:test# perf script --header -i perf.data &gt; out.stacks</span><br><span class="line">root@ubuntu:test# stackcollapse-perf.pl &lt; out.stacks | flamegraph.pl --color=java --hash --title=&quot;CPU Flame Graph, $(hostname), $(date -I)&quot; &gt; out.svg</span><br></pre></td></tr></table></figure>

<p>其中，stackcoolapse-perf.pl等工具源码路劲：<a target="_blank" rel="noopener" href="https://github.com/brendangregg/FlameGraph">https://github.com/brendangregg/FlameGraph</a></p>
<p><img src="https://raw.githubusercontent.com/junixcn/images/master/image-20210105162212874.png" alt="image-20210105162212874"></p>
<p>上图中条的宽度表示占用CPU时间的多少，main()函数中调用foo1(),foo2()后是个while(1)死循环。</p>
<h4 id="1-7-profile-bpfcc"><a href="#1-7-profile-bpfcc" class="headerlink" title="1.7 profile-bpfcc"></a>1.7 profile-bpfcc</h4><p>profile(8) is a BCC tool that samples stack traces at timed intervals and reports a frequency count.</p>
<p><strong>profile(8) has lower overhead than perf(1) as only the stack trace summary is passed to user space.</strong></p>
<p><strong>profile-bpfcc的开销比perf要小很多</strong>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test# profile-bpfcc -h</span><br><span class="line">usage: profile-bpfcc [-h] [-p PID | -L TID] [-U | -K] [-F FREQUENCY | -c COUNT] [-d] [-a] [-I] [-f] [--stack-storage-size STACK_STORAGE_SIZE] [-C CPU] [duration]</span><br><span class="line"></span><br><span class="line">Profile CPU stack traces at a timed interval</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  duration              duration of trace, in seconds</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help            show this help message and exit</span><br><span class="line">  -p PID, --pid PID     profile process with this PID only</span><br><span class="line">  -L TID, --tid TID     profile thread with this TID only</span><br><span class="line">  -U, --user-stacks-only</span><br><span class="line">                        show stacks from user space only (no kernel space stacks)</span><br><span class="line">  -K, --kernel-stacks-only</span><br><span class="line">                        show stacks from kernel space only (no user space stacks)</span><br><span class="line">  -F FREQUENCY, --frequency FREQUENCY</span><br><span class="line">                        sample frequency, Hertz</span><br><span class="line">  -c COUNT, --count COUNT</span><br><span class="line">                        sample period, number of events</span><br><span class="line">  -d, --delimited       insert delimiter between kernel/user stacks</span><br><span class="line">  -a, --annotations     add _[k] annotations to kernel frames</span><br><span class="line">  -I, --include-idle    include CPU idle stacks</span><br><span class="line">  -f, --folded          output folded format, one line per stack (for flame graphs)</span><br><span class="line">  --stack-storage-size STACK_STORAGE_SIZE</span><br><span class="line">                        the number of unique stack traces that can be stored and displayed (default 16384)</span><br><span class="line">  -C CPU, --cpu CPU     cpu number to run profile on</span><br><span class="line"></span><br><span class="line">examples:</span><br><span class="line">    ./profile             # profile stack traces at 49 Hertz until Ctrl-C</span><br><span class="line">    ./profile -F 99       # profile stack traces at 99 Hertz</span><br><span class="line">    ./profile -c 1000000  # profile stack traces every 1 in a million events</span><br><span class="line">    ./profile 5           # profile at 49 Hertz for 5 seconds only</span><br><span class="line">    ./profile -f 5        # output in folded format for flame graphs</span><br><span class="line">    ./profile -p 185      # only profile process with PID 185</span><br><span class="line">    ./profile -L 185      # only profile thread with TID 185</span><br><span class="line">    ./profile -U          # only show user space stacks (no kernel)</span><br><span class="line">    ./profile -K          # only show kernel space stacks (no user)</span><br></pre></td></tr></table></figure>

<p>用<strong>profile-bpfcc</strong>工具产生火焰图：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test# profile-bpfcc -af 10 &gt; profile.stacks</span><br><span class="line">root@ubuntu:test# flamegraph.pl --color=java --hash --title=&quot;CPU Flame Graph, profile-bpfcc, $(date -I)&quot; &lt; profile.stacks &gt; profile.svg</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/junixcn/images/master/image-20210105164432831.png" alt="image-20210105164432831"></p>
<p>profile-bpfcc显示CPU函数堆栈调用关系：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 另开一个窗口，跑示例程序 ./t1</span></span><br><span class="line">root@ubuntu:test# profile-bpfcc </span><br><span class="line">Sampling at 49 Hertz of all threads by user + kernel stack... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">    b&#x27;exit_to_usermode_loop&#x27;</span><br><span class="line">    b&#x27;exit_to_usermode_loop&#x27;</span><br><span class="line">    b&#x27;prepare_exit_to_usermode&#x27;</span><br><span class="line">    b&#x27;swapgs_restore_regs_and_return_to_usermode&#x27;</span><br><span class="line">    main</span><br><span class="line">    __libc_start_main</span><br><span class="line">    -                t1 (73307)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">    b&#x27;__lock_text_start&#x27;</span><br><span class="line">    b&#x27;__lock_text_start&#x27;</span><br><span class="line">    b&#x27;__wake_up_common_lock&#x27;</span><br><span class="line">    b&#x27;__wake_up_sync_key&#x27;</span><br><span class="line">    b&#x27;sock_def_readable&#x27;</span><br><span class="line">    b&#x27;unix_stream_sendmsg&#x27;</span><br><span class="line">    b&#x27;sock_sendmsg&#x27;</span><br><span class="line">    b&#x27;sock_write_iter&#x27;</span><br><span class="line">    b&#x27;do_iter_readv_writev&#x27;</span><br><span class="line">    b&#x27;do_iter_write&#x27;</span><br><span class="line">    b&#x27;vfs_writev&#x27;</span><br><span class="line">    b&#x27;do_writev&#x27;</span><br><span class="line">    b&#x27;__x64_sys_writev&#x27;</span><br><span class="line">    b&#x27;do_syscall_64&#x27;</span><br><span class="line">    b&#x27;entry_SYSCALL_64_after_hwframe&#x27;</span><br><span class="line">    writev</span><br><span class="line">    -                Xorg (1615)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">    b&#x27;clear_page_orig&#x27;</span><br><span class="line">    b&#x27;clear_page_orig&#x27;</span><br><span class="line">    b&#x27;get_page_from_freelist&#x27;</span><br><span class="line">    b&#x27;__alloc_pages_nodemask&#x27;</span><br><span class="line">    b&#x27;alloc_pages_current&#x27;</span><br><span class="line">    b&#x27;__get_free_pages&#x27;</span><br><span class="line">    b&#x27;pgd_alloc&#x27;</span><br><span class="line">    b&#x27;mm_init&#x27;</span><br><span class="line">    b&#x27;mm_alloc&#x27;</span><br><span class="line">    b&#x27;__do_execve_file.isra.0&#x27;</span><br><span class="line">    b&#x27;__x64_sys_execve&#x27;</span><br><span class="line">    b&#x27;do_syscall_64&#x27;</span><br><span class="line">    b&#x27;entry_SYSCALL_64_after_hwframe&#x27;</span><br><span class="line">    [unknown]</span><br><span class="line">    [unknown]</span><br><span class="line">    [unknown]</span><br><span class="line">    -                bd-qimpanel.wat (73422)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">    b&#x27;vmw_cmdbuf_header_submit&#x27;</span><br><span class="line">    b&#x27;vmw_cmdbuf_header_submit&#x27;</span><br><span class="line">    b&#x27;vmw_cmdbuf_ctx_submit.isra.0&#x27;</span><br><span class="line">    b&#x27;vmw_cmdbuf_ctx_process&#x27;</span><br><span class="line">    b&#x27;vmw_cmdbuf_man_process&#x27;</span><br><span class="line">    b&#x27;__vmw_cmdbuf_cur_flush&#x27;</span><br><span class="line">    b&#x27;vmw_cmdbuf_commit&#x27;</span><br><span class="line">    b&#x27;vmw_fifo_commit_flush&#x27;</span><br><span class="line">    b&#x27;vmw_fifo_send_fence&#x27;</span><br><span class="line">    b&#x27;vmw_execbuf_fence_commands&#x27;</span><br><span class="line">    b&#x27;vmw_execbuf_process&#x27;</span><br><span class="line">    b&#x27;vmw_execbuf_ioctl&#x27;</span><br><span class="line">    b&#x27;drm_ioctl_kernel&#x27;</span><br><span class="line">    b&#x27;drm_ioctl&#x27;</span><br><span class="line">    b&#x27;vmw_generic_ioctl&#x27;</span><br><span class="line">    b&#x27;vmw_unlocked_ioctl&#x27;</span><br><span class="line">    b&#x27;do_vfs_ioctl&#x27;</span><br><span class="line">    b&#x27;ksys_ioctl&#x27;</span><br><span class="line">    b&#x27;__x64_sys_ioctl&#x27;</span><br><span class="line">    b&#x27;do_syscall_64&#x27;</span><br><span class="line">    b&#x27;entry_SYSCALL_64_after_hwframe&#x27;</span><br><span class="line">    ioctl</span><br><span class="line">    -                Xorg (1615)</span><br><span class="line">        1</span><br><span class="line"></span><br><span class="line">    main</span><br><span class="line">    __libc_start_main</span><br><span class="line">    -                t1 (73307)</span><br><span class="line">        71</span><br></pre></td></tr></table></figure>



<h4 id="1-8-cpudist-bpfcc"><a href="#1-8-cpudist-bpfcc" class="headerlink" title="1.8 cpudist-bpfcc"></a>1.8 cpudist-bpfcc</h4><p>cpudist(8)12 is a BCC tool for showing the distribution of on-CPU time for each thread wakeup. This can be used to help characterize CPU workloads, providing details for later tuning and design decisions.</p>
<p>比如：</p>
<p>用cpudist观察进程76200的1秒时间</p>
<p>该图中的表示，<code>./t1</code>进程占用CPU的时间是1次512-1023微秒、1次1024-2047微妙等，大部分是栈8192至524287微秒。</p>
<p><img src="https://raw.githubusercontent.com/junixcn/images/master/image-20210105170716525.png" alt="image-20210105170716525"></p>
<h4 id="1-9-runqlat-bpfcc"><a href="#1-9-runqlat-bpfcc" class="headerlink" title="1.9 runqlat-bpfcc"></a>1.9 runqlat-bpfcc</h4><p>runqlat(8)工具用于测试CPU的run queue latency（虽然现在不使用run queue）。</p>
<p>用法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test# runqlat-bpfcc -h</span><br><span class="line">usage: runqlat-bpfcc [-h] [-T] [-m] [-P] [--pidnss] [-L] [-p PID] [interval] [count]</span><br><span class="line"></span><br><span class="line">Summarize run queue (scheduler) latency as a histogram</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  interval            output interval, in seconds</span><br><span class="line">  count               number of outputs</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help          show this help message and exit</span><br><span class="line">  -T, --timestamp     include timestamp on output</span><br><span class="line">  -m, --milliseconds  millisecond histogram</span><br><span class="line">  -P, --pids          print a histogram per process ID</span><br><span class="line">  --pidnss            print a histogram per PID namespace</span><br><span class="line">  -L, --tids          print a histogram per thread ID</span><br><span class="line">  -p PID, --pid PID   trace this PID only</span><br><span class="line"></span><br><span class="line">examples:</span><br><span class="line">    ./runqlat            # summarize run queue latency as a histogram</span><br><span class="line">    ./runqlat 1 10       # print 1 second summaries, 10 times</span><br><span class="line">    ./runqlat -mT 1      # 1s summaries, milliseconds, and timestamps</span><br><span class="line">    ./runqlat -P         # show each PID separately</span><br><span class="line">    ./runqlat -p 185     # trace PID 185 only</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test# runqlat-bpfcc 1 1</span><br><span class="line">Tracing run queue latency... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 3        |*                                       |</span><br><span class="line">         2 -&gt; 3          : 9        |*****                                   |</span><br><span class="line">         4 -&gt; 7          : 20       |***********                             |</span><br><span class="line">         8 -&gt; 15         : 62       |**********************************      |</span><br><span class="line">        16 -&gt; 31         : 20       |***********                             |</span><br><span class="line">        32 -&gt; 63         : 72       |****************************************|</span><br><span class="line">        64 -&gt; 127        : 8        |****                                    |</span><br><span class="line">       128 -&gt; 255        : 2        |*                                       |</span><br><span class="line">       256 -&gt; 511        : 11       |******                                  |</span><br><span class="line">       512 -&gt; 1023       : 4        |**                                      |</span><br></pre></td></tr></table></figure>

<p>runqlat(8) works by instrumenting scheduler wakeup and context switch events to determine the time from wakeup to running. These events can be very frequent on busy production systems, exceeding one million events per second. Even though BPF is optimized, at these rates even adding one microsecond per event can cause noticeable overhead. Use with caution, and consider using runqlen(8) instead.</p>
<h4 id="1-10-runqlen-bpfcc"><a href="#1-10-runqlen-bpfcc" class="headerlink" title="1.10 runqlen-bpfcc"></a>1.10 runqlen-bpfcc</h4><p>用于测试CPU的run queue队列长度数据，多个CPU汇总的histogram（直方图）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test# runqlen-bpfcc -h</span><br><span class="line">usage: runqlen-bpfcc [-h] [-T] [-O] [-C] [interval] [count]</span><br><span class="line"></span><br><span class="line">Summarize scheduler run queue length as a histogram</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  interval         output interval, in seconds</span><br><span class="line">  count            number of outputs</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help       show this help message and exit</span><br><span class="line">  -T, --timestamp  include timestamp on output</span><br><span class="line">  -O, --runqocc    report run queue occupancy</span><br><span class="line">  -C, --cpus       print output for each CPU separately</span><br><span class="line"></span><br><span class="line">examples:</span><br><span class="line">    ./runqlen            # summarize run queue length as a histogram</span><br><span class="line">    ./runqlen 1 10       # print 1 second summaries, 10 times</span><br><span class="line">    ./runqlen -T 1       # 1s summaries and timestamps</span><br><span class="line">    ./runqlen -O         # report run queue occupancy</span><br><span class="line">    ./runqlen -C         # show each CPU separately</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 用了两个终端，每个终端里个运行了一个./t1死循环进程，系统是2个CPU总共</span></span></span><br><span class="line">root@ubuntu:test# runqlen-bpfcc 1 1</span><br><span class="line">Sampling run queue length... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">     runqlen       : count     distribution</span><br><span class="line">        0          : 194      |****************************************|</span><br><span class="line"><span class="meta">   #</span><span class="bash"><span class="comment">## 上表的意思是run queue长度一直为0</span></span></span><br><span class="line"></span><br><span class="line">root@ubuntu:test# runqlen-bpfcc 1 1</span><br><span class="line">Sampling run queue length... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">     runqlen       : count     distribution</span><br><span class="line">        0          : 191      |****************************************|</span><br><span class="line">        1          : 0        |                                        |</span><br><span class="line">        2          : 2        |                                        |</span><br><span class="line">    ### 意思是：绝大部分时间run queue为0，大约1%的时间run queue队列长度为2</span><br></pre></td></tr></table></figure>



<h4 id="1-11-softirq-bpfcc"><a href="#1-11-softirq-bpfcc" class="headerlink" title="1.11 softirq-bpfcc"></a>1.11 softirq-bpfcc</h4><p>softirqs(8)15 is a BCC tool that shows the time spent servicing soft IRQs (soft interrupts). The system-wide time in soft interrupts is readily available from different tools. For example, mpstat(1) shows it as %soft. There is also /proc/softirqs to show counts of soft IRQ events. The BCC softirqs(8) tool differs in that it can show time per soft IRQ rather than an event count.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:pc# softirqs-bpfcc -h</span><br><span class="line">usage: softirqs-bpfcc [-h] [-T] [-N] [-d] [interval] [count]</span><br><span class="line"></span><br><span class="line">Summarize soft irq event time as histograms.</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  interval           output interval, in seconds</span><br><span class="line">  count              number of outputs</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help         show this help message and exit</span><br><span class="line">  -T, --timestamp    include timestamp on output</span><br><span class="line">  -N, --nanoseconds  output in nanoseconds</span><br><span class="line">  -d, --dist         show distributions as histograms</span><br><span class="line"></span><br><span class="line">examples:</span><br><span class="line">    ./softirqs            # sum soft irq event time</span><br><span class="line">    ./softirqs -d         # show soft irq event time as histograms</span><br><span class="line">    ./softirqs 1 10       # print 1 second summaries, 10 times</span><br><span class="line">    ./softirqs -NT 1      # 1s summaries, nanoseconds, and timestamps</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:pc# softirqs-bpfcc 10 1</span><br><span class="line">Tracing soft irq event time... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">SOFTIRQ          TOTAL_usecs</span><br><span class="line">net_tx                     1</span><br><span class="line">tasklet                  126</span><br><span class="line">block                    560</span><br><span class="line">rcu                     4056</span><br><span class="line">net_rx                  4325</span><br><span class="line">sched                   7397</span><br><span class="line">timer                   8293             ### 花在timer定时器的软中断时间是8.293ms</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">####################################################################</span></span></span><br><span class="line"></span><br><span class="line">root@ubuntu:pc# softirqs-bpfcc -d</span><br><span class="line">Tracing soft irq event time... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line">softirq = timer</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 28       |****************************            |</span><br><span class="line">         2 -&gt; 3          : 39       |****************************************|</span><br><span class="line">         4 -&gt; 7          : 18       |******************                      |</span><br><span class="line">         8 -&gt; 15         : 13       |*************                           |</span><br><span class="line">        16 -&gt; 31         : 5        |*****                                   |</span><br><span class="line">        32 -&gt; 63         : 2        |**                                      |</span><br><span class="line">        64 -&gt; 127        : 2        |**                                      |</span><br><span class="line"></span><br><span class="line">softirq = rcu</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 47       |****************************************|</span><br><span class="line">         2 -&gt; 3          : 14       |***********                             |</span><br><span class="line">         4 -&gt; 7          : 10       |********                                |</span><br><span class="line">         8 -&gt; 15         : 6        |*****                                   |</span><br><span class="line">        16 -&gt; 31         : 5        |****                                    |</span><br><span class="line">        32 -&gt; 63         : 0        |                                        |</span><br><span class="line">        64 -&gt; 127        : 1        |                                        |</span><br><span class="line"></span><br><span class="line">softirq = tasklet</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 8        |*****************************           |</span><br><span class="line">         2 -&gt; 3          : 11       |****************************************|</span><br><span class="line">         4 -&gt; 7          : 4        |**************                          |</span><br><span class="line"></span><br><span class="line">softirq = sched</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 8        |*********                               |</span><br><span class="line">         2 -&gt; 3          : 23       |***************************             |</span><br><span class="line">         4 -&gt; 7          : 22       |*************************               |</span><br><span class="line">         8 -&gt; 15         : 34       |****************************************|</span><br><span class="line">        16 -&gt; 31         : 18       |*********************                   |</span><br><span class="line"></span><br><span class="line">softirq = net_rx</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 5        |****************************************|</span><br><span class="line">        16 -&gt; 31         : 4        |********************************        |</span><br><span class="line">        32 -&gt; 63         : 2        |****************                        |</span><br></pre></td></tr></table></figure>



<h4 id="1-12-hardirq-bpfcc"><a href="#1-12-hardirq-bpfcc" class="headerlink" title="1.12 hardirq-bpfcc"></a>1.12 hardirq-bpfcc</h4><p>显示花在硬中断上的时间</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:pc# hardirqs-bpfcc -h</span><br><span class="line">usage: hardirqs-bpfcc [-h] [-T] [-N] [-C] [-d] [interval] [outputs]</span><br><span class="line"></span><br><span class="line">Summarize hard irq event time as histograms</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  interval           output interval, in seconds</span><br><span class="line">  outputs            number of outputs</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help         show this help message and exit</span><br><span class="line">  -T, --timestamp    include timestamp on output</span><br><span class="line">  -N, --nanoseconds  output in nanoseconds</span><br><span class="line">  -C, --count        show event counts instead of timing</span><br><span class="line">  -d, --dist         show distributions as histograms</span><br><span class="line"></span><br><span class="line">examples:</span><br><span class="line">    ./hardirqs            # sum hard irq event time</span><br><span class="line">    ./hardirqs -d         # show hard irq event time as histograms</span><br><span class="line">    ./hardirqs 1 10       # print 1 second summaries, 10 times</span><br><span class="line">    ./hardirqs -NT 1      # 1s summaries, nanoseconds, and timestamps</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:pc# hardirqs-bpfcc 2 1</span><br><span class="line">Tracing hard irq event time... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">HARDIRQ                    TOTAL_usecs</span><br><span class="line">vmw_vmci                             5</span><br><span class="line">ahci[0000:02:05.0]                  12</span><br><span class="line">vmwgfx                             259</span><br><span class="line">ens33                              414   ### 花费在ens33网卡上的硬中断时间是414us</span><br></pre></td></tr></table></figure>



<h4 id="1-13-bpftrace"><a href="#1-13-bpftrace" class="headerlink" title="1.13 bpftrace"></a>1.13 bpftrace</h4><p>bpftrace is a BPF-based tracer that provides a high-level programming language, allowing the creation of powerful one-liners and short scripts. It is well suited for custom application analysis based on clues from other tools. There are bpftrace versions of the earlier tools runqlat(8) and runqlen(8) in the bpftrace repository [Iovisor 20a].</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## bpftrace分析 t1 进程，采样频率49Hz，且只显示前3层调用栈</span></span></span><br><span class="line">root@ubuntu:test# bpftrace -e &#x27;profile:hz:49 /comm == &quot;t1&quot;/ &#123; @[ustack(3)] = count(); &#125;&#x27;</span><br><span class="line">Attaching 1 probe...</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line">@[</span><br><span class="line">    longa+20</span><br><span class="line">    foo1+31</span><br><span class="line">    main+36</span><br><span class="line">]: 1</span><br><span class="line">@[</span><br><span class="line">    longa+27</span><br><span class="line">    foo2+31</span><br><span class="line">    main+46</span><br><span class="line">]: 2</span><br><span class="line">@[</span><br><span class="line">    longa+23</span><br><span class="line">    foo1+31</span><br><span class="line">    main+36</span><br><span class="line">]: 3</span><br><span class="line">@[</span><br><span class="line">    longa+34</span><br><span class="line">    foo2+31</span><br><span class="line">    main+46</span><br><span class="line">]: 3</span><br><span class="line">@[</span><br><span class="line">    longa+17</span><br><span class="line">    foo1+31</span><br><span class="line">    main+36</span><br><span class="line">]: 8</span><br><span class="line">@[</span><br><span class="line">    longa+27</span><br><span class="line">    foo1+31</span><br><span class="line">    main+36</span><br><span class="line">]: 13</span><br><span class="line">@[</span><br><span class="line">    longa+34</span><br><span class="line">    foo1+31</span><br><span class="line">    main+36</span><br><span class="line">]: 27</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost test]# bpftrace -l &#x27;tracepoint:sched:*&#x27;</span><br><span class="line">tracepoint:sched:sched_kthread_stop</span><br><span class="line">tracepoint:sched:sched_kthread_stop_ret</span><br><span class="line">tracepoint:sched:sched_waking</span><br><span class="line">tracepoint:sched:sched_wakeup</span><br><span class="line">tracepoint:sched:sched_wakeup_new</span><br><span class="line">tracepoint:sched:sched_switch</span><br><span class="line">tracepoint:sched:sched_migrate_task</span><br><span class="line">tracepoint:sched:sched_process_free</span><br><span class="line">tracepoint:sched:sched_process_exit</span><br><span class="line">tracepoint:sched:sched_wait_task</span><br><span class="line">tracepoint:sched:sched_process_wait</span><br><span class="line">tracepoint:sched:sched_process_fork</span><br><span class="line">tracepoint:sched:sched_process_exec</span><br><span class="line">tracepoint:sched:sched_stat_wait</span><br><span class="line">tracepoint:sched:sched_stat_sleep</span><br><span class="line">tracepoint:sched:sched_stat_iowait</span><br><span class="line">tracepoint:sched:sched_stat_blocked</span><br><span class="line">tracepoint:sched:sched_stat_runtime</span><br><span class="line">tracepoint:sched:sched_pi_setprio</span><br><span class="line">tracepoint:sched:sched_process_hang</span><br><span class="line">tracepoint:sched:sched_move_numa</span><br><span class="line">tracepoint:sched:sched_stick_numa</span><br><span class="line">tracepoint:sched:sched_swap_numa</span><br><span class="line">tracepoint:sched:sched_wake_idle_without_ipi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost test]# bpftrace -lv &quot;kprobe:sched*&quot;</span><br><span class="line">kprobe:sched_itmt_update_handler</span><br><span class="line">kprobe:sched_set_itmt_support</span><br><span class="line">kprobe:sched_clear_itmt_support</span><br><span class="line">kprobe:sched_set_itmt_core_prio</span><br><span class="line">kprobe:schedule_on_each_cpu</span><br><span class="line">kprobe:sched_copy_attr</span><br><span class="line">kprobe:sched_free_group</span><br><span class="line">kprobe:sched_free_group_rcu</span><br><span class="line">kprobe:sched_read_attr</span><br><span class="line">kprobe:sched_show_task</span><br><span class="line">kprobe:sched_change_group</span><br><span class="line">kprobe:sched_rr_get_interval</span><br><span class="line">kprobe:sched_setscheduler</span><br><span class="line">kprobe:sched_setscheduler_nocheck</span><br><span class="line">kprobe:sched_setattr</span><br><span class="line">kprobe:sched_tick_remote</span><br><span class="line">kprobe:sched_can_stop_tick</span><br><span class="line">kprobe:sched_set_stop_task</span><br><span class="line">kprobe:sched_ttwu_pending</span><br><span class="line">kprobe:scheduler_ipi</span><br><span class="line">kprobe:sched_fork</span><br><span class="line">kprobe:schedule_tail</span><br><span class="line">kprobe:sched_exec</span><br><span class="line">kprobe:scheduler_tick</span><br><span class="line">kprobe:sched_setattr_nocheck</span><br><span class="line">kprobe:sched_setaffinity</span><br><span class="line">kprobe:sched_getaffinity</span><br><span class="line">kprobe:sched_setnuma</span><br><span class="line">kprobe:sched_cpu_activate</span><br><span class="line">kprobe:sched_cpu_deactivate</span><br><span class="line">kprobe:sched_cpu_starting</span><br><span class="line">kprobe:sched_cpu_dying</span><br><span class="line">kprobe:sched_create_group</span><br><span class="line">kprobe:sched_online_group</span><br><span class="line">kprobe:sched_destroy_group</span><br><span class="line">kprobe:sched_offline_group</span><br><span class="line">kprobe:sched_move_task</span><br><span class="line">kprobe:sched_show_task.part.60</span><br><span class="line">kprobe:sched_idle_set_state</span><br><span class="line">kprobe:sched_slice.isra.61</span><br><span class="line">kprobe:sched_init_granularity</span><br><span class="line">kprobe:sched_proc_update_handler</span><br><span class="line">kprobe:sched_cfs_slack_timer</span><br><span class="line">kprobe:sched_cfs_period_timer</span><br><span class="line">kprobe:sched_group_set_shares</span><br><span class="line">kprobe:sched_rt_rq_enqueue</span><br><span class="line">kprobe:sched_rt_period_timer</span><br><span class="line">kprobe:sched_rt_bandwidth_account</span><br><span class="line">kprobe:sched_group_set_rt_runtime</span><br><span class="line">kprobe:sched_group_rt_runtime</span><br><span class="line">kprobe:sched_group_set_rt_period</span><br><span class="line">kprobe:sched_group_rt_period</span><br><span class="line">kprobe:sched_rt_can_attach</span><br><span class="line">kprobe:sched_rt_handler</span><br><span class="line">kprobe:sched_rr_handler</span><br><span class="line">kprobe:sched_dl_global_validate</span><br><span class="line">kprobe:sched_dl_do_global</span><br><span class="line">kprobe:sched_dl_overflow</span><br><span class="line">kprobe:sched_get_rd</span><br><span class="line">kprobe:sched_put_rd</span><br><span class="line">kprobe:sched_init_numa</span><br><span class="line">kprobe:sched_domains_numa_masks_set</span><br><span class="line">kprobe:sched_domains_numa_masks_clear</span><br><span class="line">kprobe:sched_domains_numa_masks_clear</span><br><span class="line">kprobe:sched_init_domains</span><br><span class="line">kprobe:sched_numa_warn.part.8</span><br><span class="line">kprobe:sched_autogroup_create_attach</span><br><span class="line">kprobe:sched_autogroup_detach</span><br><span class="line">kprobe:sched_autogroup_exit_task</span><br><span class="line">kprobe:sched_autogroup_fork</span><br><span class="line">kprobe:sched_autogroup_exit</span><br><span class="line">kprobe:schedstat_stop</span><br><span class="line">kprobe:schedstat_start</span><br><span class="line">kprobe:schedstat_next</span><br><span class="line">kprobe:sched_debug_stop</span><br><span class="line">kprobe:sched_feat_open</span><br><span class="line">kprobe:sched_feat_show</span><br><span class="line">kprobe:sched_feat_write</span><br><span class="line">kprobe:sched_debug_header</span><br><span class="line">kprobe:sched_debug_start</span><br><span class="line">kprobe:sched_debug_next</span><br><span class="line">kprobe:sched_debug_show</span><br><span class="line">kprobe:sched_partition_show</span><br><span class="line">kprobe:sched_partition_write</span><br><span class="line">kprobe:sched_autogroup_open</span><br><span class="line">kprobe:sched_open</span><br><span class="line">kprobe:sched_write</span><br><span class="line">kprobe:sched_autogroup_show</span><br><span class="line">kprobe:sched_show</span><br><span class="line">kprobe:sched_autogroup_write</span><br><span class="line">kprobe:schedule_console_callback</span><br><span class="line">kprobe:sched_send_work</span><br><span class="line">kprobe:schedule</span><br><span class="line">kprobe:schedule_idle</span><br><span class="line">kprobe:schedule_user</span><br><span class="line">kprobe:schedule_preempt_disabled</span><br><span class="line">kprobe:schedule_timeout</span><br><span class="line">kprobe:schedule_timeout_interruptible</span><br><span class="line">kprobe:schedule_timeout_killable</span><br><span class="line">kprobe:schedule_timeout_uninterruptible</span><br><span class="line">kprobe:schedule_timeout_idle</span><br><span class="line">kprobe:schedule_hrtimeout_range_clock</span><br><span class="line">kprobe:schedule_hrtimeout_range</span><br><span class="line">kprobe:schedule_hrtimeout</span><br></pre></td></tr></table></figure>



<h3 id="2-Memory"><a href="#2-Memory" class="headerlink" title="2. Memory"></a>2. Memory</h3><h4 id="2-1-vmstat"><a href="#2-1-vmstat" class="headerlink" title="2.1 vmstat"></a>2.1 vmstat</h4><p>vmstat统计虚拟内存使用情况</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Usage:</span><br><span class="line"> vmstat [options] [delay [count]]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line"> -a, --active           active/inactive memory</span><br><span class="line"> -f, --forks            number of forks since boot</span><br><span class="line"> -m, --slabs            slabinfo</span><br><span class="line"> -n, --one-header       do not redisplay header</span><br><span class="line"> -s, --stats            event counter statistics</span><br><span class="line"> -d, --disk             disk statistics</span><br><span class="line"> -D, --disk-sum         summarize disk statistics</span><br><span class="line"> -p, --partition &lt;dev&gt;  partition specific statistics</span><br><span class="line"> -S, --unit &lt;char&gt;      define display unit  ### 单位k(1000),K(1024),m(1000000),M(1048576) bytes</span><br><span class="line"> -w, --wide             wide output</span><br><span class="line"> -t, --timestamp        show timestamp</span><br><span class="line"></span><br><span class="line"> -h, --help     display this help and exit</span><br><span class="line"> -V, --version  output version information and exit</span><br><span class="line"></span><br><span class="line">For more details see vmstat(8).</span><br></pre></td></tr></table></figure>



<p>vmstat查看虚拟内存使用信息</p>
<p><img src="https://raw.githubusercontent.com/junixcn/images/master/vmstat-1.png" alt="vmstat-1"></p>
<p>vmstat查看disk、查看slab使用信息</p>
<p><img src="https://raw.githubusercontent.com/junixcn/images/master/vmstat.png" alt="vmstat"></p>
<h4 id="2-2-PSI"><a href="#2-2-PSI" class="headerlink" title="2.2 PSI"></a>2.2 PSI</h4><p>Linux pressure stall information (PSI), added in Linux 4.20, includes statistics for memory saturation. These not only show if there is memory pressure, but how it is changing in the last five minutes.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> cat /proc/pressure/memory</span></span><br><span class="line">some avg10=2.84 avg60=1.23 avg300=0.32 total=1468344</span><br><span class="line">full avg10=1.85 avg60=0.66 avg300=0.16 total=702578</span><br></pre></td></tr></table></figure>

<p>上表数据表明，300秒平均内，内存压力是0.32，近10秒内内存压力平均是2.84，表明压力在增加。这些平均值代表进程阻塞在内存memory上的时间百分比。</p>
<p>some一行表示某些进程（线程）受影响。full一行表示所有的可运行状态进程受影响。</p>
<h4 id="2-3-swapon"><a href="#2-3-swapon" class="headerlink" title="2.3 swapon"></a>2.3 swapon</h4><p>swapon, swapoff - enable/disable devices and files for paging and swapping</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapon [options] [specialfile...]</span><br><span class="line">swapoff [-va] [specialfile...]</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test# swapon</span><br><span class="line">NAME      TYPE SIZE USED PRIO</span><br><span class="line">/swapfile file   2G   0B   -2</span><br></pre></td></tr></table></figure>



<h4 id="2-4-slabtop"><a href="#2-4-slabtop" class="headerlink" title="2.4 slabtop"></a>2.4 slabtop</h4><p>The Linux slabtop(1) command prints kernel slab cache usage from the slab allocator.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Usage:</span><br><span class="line"> slabtop [options]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line"> -d, --delay &lt;secs&gt;  delay updates</span><br><span class="line"> -o, --once          only display once, then exit</span><br><span class="line"> -s, --sort &lt;char&gt;   specify sort criteria by character (see below)</span><br><span class="line"></span><br><span class="line"> -h, --help     display this help and exit</span><br><span class="line"> -V, --version  output version information and exit</span><br><span class="line"></span><br><span class="line">The following are valid sort criteria:</span><br><span class="line"> a: sort by number of active objects</span><br><span class="line"> b: sort by objects per slab</span><br><span class="line"> c: sort by cache size</span><br><span class="line"> l: sort by number of slabs</span><br><span class="line"> v: sort by number of active slabs</span><br><span class="line"> n: sort by name</span><br><span class="line"> o: sort by number of objects (the default)</span><br><span class="line"> p: sort by pages per slab</span><br><span class="line"> s: sort by object size</span><br><span class="line"> u: sort by cache utilization</span><br><span class="line"></span><br><span class="line">For more details see slabtop(1).</span><br></pre></td></tr></table></figure>

<p>输出示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"> #</span><span class="bash"> slabtop -sc</span></span><br><span class="line"> Active / Total Objects (% used)    : 760383 / 826391 (92.0%)</span><br><span class="line"> Active / Total Slabs (% used)      : 16594 / 16594 (100.0%)</span><br><span class="line"> Active / Total Caches (% used)     : 104 / 166 (62.7%)</span><br><span class="line"> Active / Total Size (% used)       : 195981.65K / 223865.73K (87.5%)</span><br><span class="line"> Minimum / Average / Maximum Object : 0.01K / 0.27K / 12.00K</span><br><span class="line"></span><br><span class="line">  OBJS ACTIVE  USE OBJ SIZE  SLABS OBJ/SLAB CACHE SIZE NAME                   </span><br><span class="line"> 36105  23984  66%    1.07K   1245       29     39840K ext4_inode_cache</span><br><span class="line"> 36093  34103  94%    0.59K    681       53     21792K inode_cache</span><br><span class="line"> 90678  67214  74%    0.19K   2159       42     17272K dentry</span><br><span class="line"> 30528  29542  96%    0.50K    477       64     15264K kmalloc-512</span><br><span class="line"> 25200  18135  71%    0.57K    450       56     14400K radix_tree_node</span><br><span class="line">106740 104353  97%    0.13K   1779       60     14232K kernfs_node_cache</span><br><span class="line"> 50271  49000  97%    0.20K   1289       39     10312K vm_area_struct</span><br><span class="line"> 99645  96008  96%    0.10K   2555       39     10220K buffer_head</span><br><span class="line">  2176   2169  99%    4.00K    272        8      8704K kmalloc-4k</span><br><span class="line"> 32320  29153  90%    0.25K    505       64      8080K filp</span><br><span class="line">  1045    931  89%    5.81K    209        5      6688K task_struct</span><br><span class="line">  9744   9471  97%    0.66K    203       48      6496K proc_inode_cache</span><br><span class="line">  5376   5078  94%    1.00K    168       32      5376K kmalloc-1k</span><br><span class="line">  5148   4919  95%    0.81K    132       39      4224K sock_inode_cache</span><br><span class="line">  1920   1920 100%    2.00K    120       16      3840K kmalloc-2k</span><br><span class="line">   416    399  95%    8.00K    104        4      3328K kmalloc-8k</span><br><span class="line">  3104   3049  98%    1.00K     97       32      3104K PING</span><br><span class="line"> 36224  35192  97%    0.06K    566       64      2264K anon_vma_chain</span><br><span class="line">  3060   2742  89%    0.70K     68       45      2176K shmem_inode_cache</span><br><span class="line">   915    899  98%    2.06K     61       15      1952K sighand_cache</span><br><span class="line">  7680   7680 100%    0.25K    120       64      1920K skbuff_head_cache</span><br><span class="line"> 20700  20444  98%    0.09K    450       46      1800K anon_vma</span><br><span class="line">  1350   1350 100%    1.06K     45       30      1440K signal_cache</span><br><span class="line"> 44544  44544 100%    0.03K    348      128      1392K kmalloc-32</span><br><span class="line">  1280    992  77%    1.00K     40       32      1280K RAW</span><br><span class="line"> 19840  19148  96%    0.06K    310       64      1240K kmalloc-64</span><br><span class="line">  1110   1110 100%    1.06K     37       30      1184K mm_struct</span><br><span class="line">   936    681  72%    1.19K     36       26      1152K RAWv6</span><br><span class="line">  1518   1518 100%    0.69K     33       46      1056K files_cache</span><br><span class="line">  3776   3741  99%    0.25K     59       64       944K kmalloc-256</span><br><span class="line">  7232   7169  99%    0.12K    113       64       904K pid</span><br><span class="line">  1980   1912  96%    0.44K     55       36       880K kmem_cache</span><br><span class="line">  4620   4579  99%    0.19K    110       42       880K cred_jar</span><br><span class="line">   616    616 100%    1.12K     22       28       704K UDP</span><br><span class="line">  3486   3251  93%    0.19K     83       42       664K kmalloc-192</span><br><span class="line">  9984   9440  94%    0.06K    156       64       624K vmap_area</span><br></pre></td></tr></table></figure>

<p>查看slab信息的其他方法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> cat /proc/slabinfo</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> vmstat -m</span></span><br></pre></td></tr></table></figure>



<h4 id="2-5-pmap"><a href="#2-5-pmap" class="headerlink" title="2.5 pmap"></a>2.5 pmap</h4><p>pmap - report memory map of a process.</p>
<p>The pmap command reports the memory map of a process or processes.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Usage:</span><br><span class="line"> pmap [options] PID [PID ...]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line"> -x, --extended              show details</span><br><span class="line"> -X                          show even more details</span><br><span class="line">            WARNING: format changes according to /proc/PID/smaps</span><br><span class="line"> -XX                         show everything the kernel provides</span><br><span class="line"> -c, --read-rc               read the default rc</span><br><span class="line"> -C, --read-rc-from=&lt;file&gt;   read the rc from file</span><br><span class="line"> -n, --create-rc             create new default rc</span><br><span class="line"> -N, --create-rc-to=&lt;file&gt;   create new rc to file</span><br><span class="line">            NOTE: pid arguments are not allowed with -n, -N</span><br><span class="line"> -d, --device                show the device format</span><br><span class="line"> -q, --quiet                 do not display header and footer</span><br><span class="line"> -p, --show-path             show path in the mapping</span><br><span class="line"> -A, --range=&lt;low&gt;[,&lt;high&gt;]  limit results to the given range</span><br><span class="line"></span><br><span class="line"> -h, --help     display this help and exit</span><br><span class="line"> -V, --version  output version information and exit</span><br><span class="line"></span><br><span class="line">For more details see pmap(1).</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test# pgrep t1</span><br><span class="line">133524</span><br><span class="line">root@ubuntu:test# ps 133524</span><br><span class="line">    PID TTY      STAT   TIME COMMAND</span><br><span class="line"> 133524 pts/0    R+     0:14 ./t1</span><br><span class="line">root@ubuntu:test# </span><br><span class="line">root@ubuntu:test# pmap 133524</span><br><span class="line">133524:   ./t1</span><br><span class="line">00005594bda0b000      4K r---- t1</span><br><span class="line">00005594bda0c000      4K r-x-- t1</span><br><span class="line">00005594bda0d000      4K r---- t1</span><br><span class="line">00005594bda0e000      4K r---- t1</span><br><span class="line">00005594bda0f000      4K rw--- t1</span><br><span class="line">00007f42a5fc4000    148K r---- libc-2.31.so</span><br><span class="line">00007f42a5fe9000   1504K r-x-- libc-2.31.so</span><br><span class="line">00007f42a6161000    296K r---- libc-2.31.so</span><br><span class="line">00007f42a61ab000      4K ----- libc-2.31.so</span><br><span class="line">00007f42a61ac000     12K r---- libc-2.31.so</span><br><span class="line">00007f42a61af000     12K rw--- libc-2.31.so</span><br><span class="line">00007f42a61b2000     24K rw---   [ anon ]</span><br><span class="line">00007f42a61ce000      4K r---- ld-2.31.so</span><br><span class="line">00007f42a61cf000    140K r-x-- ld-2.31.so</span><br><span class="line">00007f42a61f2000     32K r---- ld-2.31.so</span><br><span class="line">00007f42a61fb000      4K r---- ld-2.31.so</span><br><span class="line">00007f42a61fc000      4K rw--- ld-2.31.so</span><br><span class="line">00007f42a61fd000      4K rw---   [ anon ]</span><br><span class="line">00007ffdf656f000    132K rw---   [ stack ]</span><br><span class="line">00007ffdf65c7000     12K r----   [ anon ]</span><br><span class="line">00007ffdf65ca000      4K r-x--   [ anon ]</span><br><span class="line">ffffffffff600000      4K --x--   [ anon ]</span><br><span class="line"> total             2360K</span><br></pre></td></tr></table></figure>



<h4 id="2-6-perf"><a href="#2-6-perf" class="headerlink" title="2.6 perf"></a>2.6 perf</h4><p>perf中关于memory的分析使用常用命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf record -e page-faults -a -g  # 全局采样page faults（RSS增长）</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>VSS</td>
<td>VSS - Virtual Set Size （用处不大），虚拟耗用内存（包含共享库占用的内存，以及分配但未使用的内存）</td>
</tr>
<tr>
<td>RSS</td>
<td>RSS - Resident Set Size （用处不大），实际使用物理内存（包含共享库占用的内存）</td>
</tr>
<tr>
<td>PSS</td>
<td>PSS - Proportional Set Size （参考），实际使用的物理内存（比例分配共享库占用的内存，按照进程数等比例划分）</td>
</tr>
<tr>
<td>USS</td>
<td>USS - Unique Set Size （非常有用），进程独自占用的物理内存（不包含共享库占用的内存）</td>
</tr>
</tbody></table>
<p><img src="images/2828107-946368da958a6504.png" alt="img"></p>
<p><img src="https://raw.githubusercontent.com/junixcn/images/master/2828107-219e9bf1b34efbdb.png" alt="img"></p>
<p><img src="https://raw.githubusercontent.com/junixcn/images/master/2828107-bf9353a80d3829b4.png" alt="img"></p>
<p><img src="https://raw.githubusercontent.com/junixcn/images/master/2828107-9a4abd14e2cd5391.png" alt="img"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">perf record -e page-faults -c 1 -p &lt;pid&gt; -g -- sleep 60  # 记录指定pid所有的page faults的栈信息60秒</span><br><span class="line">perf record -e syscalls:sys_enter_brk -a -g  # 记录通过brk(2)系统调用的堆增长</span><br><span class="line">perf record -e migrate:mm_migrate_pages -a  # 统计NUMA系统上的page迁移</span><br><span class="line">perf stat -e &#x27;kmem:*&#x27; -a -I 1000  # 统计所有的kmem事件，每隔1秒打印一次</span><br><span class="line">perf stat -e &#x27;vmscan:*&#x27; -a -I 1000  # 统计所有vmscan事件，每秒打印1次</span><br><span class="line">perf stat -e &#x27;compaction:*&#x27; -a -I 1000  # 统计所有内存compaction事件，每秒打印1次</span><br><span class="line">perf record -e vmscan:mm_vmscan_wakeup_kswapd -ag  # 跟踪kswapd唤醒事件的栈信息</span><br><span class="line">perf mem record [command]  # 针对command进行内存访问分析记录</span><br><span class="line">perf mem report  # 读取memory分析记录文件</span><br></pre></td></tr></table></figure>



<h5 id="page-fault-采样分析"><a href="#page-fault-采样分析" class="headerlink" title="page fault 采样分析"></a>page fault 采样分析</h5><p>Since page faults occur as a process increases its resident set size (RSS), analyzing them can explain why the main memory of a process is growing.</p>
<p>内存火焰图：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">perf record -e page-faults -a -g -- sleep 20</span><br><span class="line">perf script --header &gt; out.stacks</span><br><span class="line">stackcollapse-perf.pl &lt; out.stacks | flamegraph.pl --hash --bgcolor=green --count=pages --title=&quot;Page Fault Flame Graph, $(hostname), $(date -I)&quot; &gt; out.svg</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/junixcn/images/master/image-20210106140524119.png" alt="image-20210106140524119"></p>
<h4 id="2-7-drsnoop-bpfcc"><a href="#2-7-drsnoop-bpfcc" class="headerlink" title="2.7 drsnoop-bpfcc"></a>2.7 drsnoop-bpfcc</h4><p>drsnoop工具用于统计显示direct reclaim（直接回收）内存事件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">usage: drsnoop-bpfcc [-h] [-T] [-U] [-p PID] [-t TID] [-u UID] [-d DURATION] [-n NAME] [-v]</span><br><span class="line"></span><br><span class="line">Trace direct reclaim</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help            show this help message and exit</span><br><span class="line">  -T, --timestamp       include timestamp on output</span><br><span class="line">  -U, --print-uid       print UID column</span><br><span class="line">  -p PID, --pid PID     trace this PID only</span><br><span class="line">  -t TID, --tid TID     trace this TID only</span><br><span class="line">  -u UID, --uid UID     trace this UID only</span><br><span class="line">  -d DURATION, --duration DURATION</span><br><span class="line">                        total duration of trace in seconds</span><br><span class="line">  -n NAME, --name NAME  only print process names containing this name</span><br><span class="line">  -v, --verbose         show system memory state</span><br><span class="line"></span><br><span class="line">examples:</span><br><span class="line">    ./drsnoop           # trace all direct reclaim</span><br><span class="line">    ./drsnoop -T        # include timestamps</span><br><span class="line">    ./drsnoop -U        # include UID</span><br><span class="line">    ./drsnoop -P 181    # only trace PID 181</span><br><span class="line">    ./drsnoop -t 123    # only trace TID 123</span><br><span class="line">    ./drsnoop -u 1000   # only trace UID 1000</span><br><span class="line">    ./drsnoop -d 10     # trace for 10 seconds only</span><br><span class="line">    ./drsnoop -n main   # only print process names containing &quot;main&quot;</span><br></pre></td></tr></table></figure>

<p>试了一下，在虚拟机ubuntu中该工具运行未能结束（暂未去定位问题）</p>
<h4 id="2-8-bpftrace"><a href="#2-8-bpftrace" class="headerlink" title="2.8 bpftrace"></a>2.8 bpftrace</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bpftrace -e &#x27;uprobe:/lib/x86_64-linux-gnu/libc.so.6:malloc &#123; @[ustack, comm] = sum(arg0); &#125;&#x27;  # 统计malloc调用的字节数总和</span><br></pre></td></tr></table></figure>

<p>User-level allocations can be traced from the allocation functions used. For this example, the malloc(3) function from libc is traced for PID 5296：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test_mem# pgrep t1</span><br><span class="line">5296</span><br><span class="line">root@ubuntu:test_mem# bpftrace -e &#x27;uprobe:/lib/x86_64-linux-gnu/libc.so.6:malloc /pid == 5296/ &#123; @[ustack] = hist(arg0); &#125;&#x27;</span><br><span class="line">Attaching 1 probe...</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line">@[</span><br><span class="line">    __libc_malloc+0</span><br><span class="line">    main+38</span><br><span class="line">    __libc_start_main+243</span><br><span class="line">]: </span><br><span class="line">[8K, 16K)              4 |@@@@@@@@@@@@@                                       |</span><br><span class="line">[16K, 32K)            16 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line">[32K, 64K)             4 |@@@@@@@@@@@@@                                       |</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 意思是malloc分配的字节在8K至16K的由4次，16K至32K的由16次，32K至64K的有4次</span></span></span><br></pre></td></tr></table></figure>

<p>bpftrace这个追踪malloc的火焰图一直失败，没弄出来，有bug</p>
<h3 id="3-File-Systems"><a href="#3-File-Systems" class="headerlink" title="3. File Systems"></a>3. File Systems</h3><h4 id="3-1-mount"><a href="#3-1-mount" class="headerlink" title="3.1 mount"></a>3.1 mount</h4><p>挂载文件系统工具，也可显示已经挂载的文件系统，比如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mount -l</span><br><span class="line">sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,relatime,seclabel)</span><br><span class="line">proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">devtmpfs on /dev type devtmpfs (rw,nosuid,seclabel,size=74050796k,nr_inodes=18512699,mode=755)</span><br><span class="line">securityfs on /sys/kernel/security type securityfs (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">tmpfs on /dev/shm type tmpfs (rw,nosuid,nodev,seclabel)</span><br><span class="line">devpts on /dev/pts type devpts (rw,nosuid,noexec,relatime,seclabel,gid=5,mode=620,ptmxmode=000)</span><br><span class="line">tmpfs on /run type tmpfs (rw,nosuid,nodev,seclabel,mode=755)</span><br><span class="line">tmpfs on /sys/fs/cgroup type tmpfs (ro,nosuid,nodev,noexec,seclabel,mode=755)</span><br><span class="line">cgroup on /sys/fs/cgroup/systemd type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,xattr,release_agent=/usr/lib/systemd/systemd-cgroups-agent,name=systemd)</span><br><span class="line">pstore on /sys/fs/pstore type pstore (rw,nosuid,nodev,noexec,relatime,seclabel)</span><br><span class="line">efivarfs on /sys/firmware/efi/efivars type efivarfs (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">bpf on /sys/fs/bpf type bpf (rw,nosuid,nodev,noexec,relatime,mode=700)</span><br><span class="line">cgroup on /sys/fs/cgroup/perf_event type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,perf_event)</span><br><span class="line">cgroup on /sys/fs/cgroup/rdma type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,rdma)</span><br><span class="line">cgroup on /sys/fs/cgroup/hugetlb type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,hugetlb)</span><br><span class="line">cgroup on /sys/fs/cgroup/cpu,cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,cpu,cpuacct)</span><br><span class="line">cgroup on /sys/fs/cgroup/pids type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,pids)</span><br><span class="line">cgroup on /sys/fs/cgroup/freezer type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,freezer)</span><br><span class="line">cgroup on /sys/fs/cgroup/net_cls,net_prio type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,net_cls,net_prio)</span><br><span class="line">cgroup on /sys/fs/cgroup/devices type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,devices)</span><br><span class="line">cgroup on /sys/fs/cgroup/cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,cpuset)</span><br><span class="line">cgroup on /sys/fs/cgroup/memory type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,memory)</span><br><span class="line">cgroup on /sys/fs/cgroup/blkio type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,blkio)</span><br><span class="line">configfs on /sys/kernel/config type configfs (rw,relatime)</span><br><span class="line">/dev/sde1 on / type ext4 (rw,relatime,seclabel)</span><br><span class="line">selinuxfs on /sys/fs/selinux type selinuxfs (rw,relatime)</span><br><span class="line">mqueue on /dev/mqueue type mqueue (rw,relatime,seclabel)</span><br><span class="line">hugetlbfs on /dev/hugepages type hugetlbfs (rw,relatime,seclabel,pagesize=2M)</span><br><span class="line">debugfs on /sys/kernel/debug type debugfs (rw,relatime,seclabel)</span><br><span class="line">systemd-1 on /proc/sys/fs/binfmt_misc type autofs (rw,relatime,fd=46,pgrp=1,timeout=0,minproto=5,maxproto=5,direct,pipe_ino=15426)</span><br><span class="line">fusectl on /sys/fs/fuse/connections type fusectl (rw,relatime)</span><br><span class="line">binfmt_misc on /proc/sys/fs/binfmt_misc type binfmt_misc (rw,relatime)</span><br><span class="line">/dev/sda2 on /boot type ext4 (rw,relatime,seclabel)</span><br><span class="line">/dev/sda1 on /boot/efi type vfat (rw,relatime,fmask=0077,dmask=0077,codepage=437,iocharset=ascii,shortname=winnt,errors=remount-ro)</span><br><span class="line">/dev/sdb1 on /mnt type xfs (rw,relatime,seclabel,attr2,inode64,noquota)</span><br><span class="line">/dev/sda3 on /home type xfs (rw,relatime,seclabel,attr2,inode64,noquota)</span><br><span class="line">/dev/sdc1 on /ImageStore type ext4 (rw,relatime,seclabel)</span><br><span class="line">/dev/sdd1 on /mnt1 type ext4 (rw,relatime,seclabel)</span><br><span class="line">sunrpc on /var/lib/nfs/rpc_pipefs type rpc_pipefs (rw,relatime)</span><br><span class="line">tmpfs on /run/user/0 type tmpfs (rw,nosuid,nodev,relatime,seclabel,size=14817040k,mode=700)</span><br><span class="line">gvfsd-fuse on /run/user/0/gvfs type fuse.gvfsd-fuse (rw,nosuid,nodev,relatime,user_id=0,group_id=0)</span><br><span class="line">gvfsd-fuse on /run/user/0/gvfs type fuse.gvfsd-fuse (rw,nosuid,nodev,relatime,user_id=0,group_id=0)</span><br><span class="line">/dev/sdc1 on /work type ext4 (rw,relatime,seclabel)</span><br><span class="line">tracefs on /sys/kernel/debug/tracing type tracefs (rw,relatime,seclabel)</span><br></pre></td></tr></table></figure>



<h4 id="3-2-free"><a href="#3-2-free" class="headerlink" title="3.2 free"></a>3.2 free</h4><p>The Linux free(1) command shows memory and swap statistics.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# free -mwh</span><br><span class="line">              total        used        free      shared     buffers       cache   available</span><br><span class="line">Mem:          141Gi        22Gi       3.7Gi       113Mi       1.2Gi       114Gi       117Gi</span><br><span class="line">Swap:         4.0Gi       1.5Gi       2.5Gi</span><br></pre></td></tr></table></figure>



<h4 id="3-3-slabtop"><a href="#3-3-slabtop" class="headerlink" title="3.3 slabtop"></a>3.3 slabtop</h4><h4 id="3-4-strace"><a href="#3-4-strace" class="headerlink" title="3.4 strace"></a>3.4 strace</h4><p>File system latency can be measured at the syscall interface using tracing tools including strace(1) for Linux. However, the current ptrace(2)-based implementation of strace(1) can severely hurt performance and may be suitable for use only when the performance overhead is acceptable and other methods to analyze latency are not possible.</p>
<p>跟踪系统调用情况，但对性能有较大影响，除非测试时可以忽略starce带来的性能开销，否则测试不准确。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test_mem# pgrep t1</span><br><span class="line">7632</span><br><span class="line">root@ubuntu:test_mem# strace -ttT -p 7632</span><br><span class="line">strace: Process 7632 attached</span><br><span class="line">15:32:54.202519 restart_syscall(&lt;... resuming interrupted read ...&gt;) = 0 &lt;0.146219&gt;</span><br><span class="line">15:32:54.542522 write(1, &quot;sleep 1 seconds\n&quot;, 16) = 16 &lt;0.000068&gt;</span><br><span class="line">15:32:54.542690 clock_nanosleep(CLOCK_REALTIME, 0, &#123;tv_sec=1, tv_nsec=0&#125;, 0x7fff91352fa0) = 0 &lt;1.000947&gt;</span><br><span class="line">15:32:55.741211 write(1, &quot;sleep 1 seconds\n&quot;, 16) = 16 &lt;0.000065&gt;</span><br><span class="line">15:32:55.741372 clock_nanosleep(CLOCK_REALTIME, 0, &#123;tv_sec=1, tv_nsec=0&#125;, 0x7fff91352fa0) = 0 &lt;1.000272&gt;</span><br><span class="line">15:32:56.935367 write(1, &quot;sleep 1 seconds\n&quot;, 16) = 16 &lt;0.000037&gt;</span><br><span class="line">15:32:56.935476 clock_nanosleep(CLOCK_REALTIME, 0, &#123;tv_sec=1, tv_nsec=0&#125;, 0x7fff91352fa0) = 0 &lt;1.000639&gt;</span><br><span class="line">15:32:58.132054 write(1, &quot;sleep 1 seconds\n&quot;, 16) = 16 &lt;0.000080&gt;</span><br></pre></td></tr></table></figure>



<h4 id="3-5-fatrace"><a href="#3-5-fatrace" class="headerlink" title="3.5 fatrace"></a>3.5 fatrace</h4><p>fatrace可以全局跟踪所有进程的file access事件，它基于Linux的fanotify API（file access notify）。可以是read（R），write（W），open（O）事件。但fatrace对CPU的消耗也是较大的，可以用BPF工具如opensnoop替代。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test_mem# fatrace -t</span><br><span class="line">15:46:53.488596 sh(10908): RO /usr/bin/dash</span><br><span class="line">15:46:53.488596 sh(10908): RO /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br><span class="line">15:46:53.488596 sh(10908): O /etc/ld.so.cache</span><br><span class="line">15:46:53.488596 sh(10908): RO /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br><span class="line">15:46:53.488753 sh(10908): C /etc/ld.so.cache</span><br><span class="line">15:46:53.488868 rsyslogd(762): W /var/log/syslog</span><br><span class="line">15:46:53.491343 pidof(10909): RO /usr/sbin/killall5</span><br><span class="line">15:46:53.491343 pidof(10909): RO /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br><span class="line">15:46:53.491343 pidof(10909): CO /etc/ld.so.cache</span><br><span class="line">15:46:53.491343 pidof(10909): RO /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br><span class="line">15:46:53.494075 pidof(10909): C /usr/sbin/killall5</span><br><span class="line">15:46:53.494075 pidof(10909): C /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br><span class="line">15:46:53.494075 pidof(10909): C /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br><span class="line">15:46:53.494296 unknown(10908): C /usr/bin/dash</span><br><span class="line">15:46:53.494296 unknown(10908): C /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br><span class="line">15:46:53.494296 unknown(10908): C /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br><span class="line">15:46:53.495210 sogouImeService(10910): RO /usr/bin/kill</span><br><span class="line">15:46:53.495210 sogouImeService(10910): RO /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br><span class="line">15:46:53.495686 kill(10910): O /etc/ld.so.cache</span><br><span class="line">15:46:53.495726 kill(10910): RO /usr/lib/x86_64-linux-gnu/libprocps.so.8.0.2</span><br><span class="line">15:46:53.495755 kill(10910): O /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br><span class="line">15:46:53.495782 kill(10910): R /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br><span class="line">15:46:53.495854 kill(10910): RO /usr/lib/x86_64-linux-gnu/libsystemd.so.0.28.0</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>



<h4 id="3-6-latencytop"><a href="#3-6-latencytop" class="headerlink" title="3.6 latencytop"></a>3.6 latencytop</h4><p>需要<code>CONFIG_LATENCYTOP</code>支持</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test_mem# latencytop -h</span><br><span class="line">mount: /sys/kernel/debug: none already mounted on /sys/fs/bpf.</span><br><span class="line">Gtk-Message: 15:48:26.202: Failed to load module &quot;canberra-gtk-module&quot;</span><br><span class="line">Please enable the CONFIG_LATENCYTOP configuration in your kernel.</span><br><span class="line">Exiting...</span><br><span class="line">root@ubuntu:test_mem# cat /lib/modules/5.4.0-58-generic/build/.config | grep LATENCY</span><br><span class="line"><span class="meta">#</span><span class="bash"> CONFIG_BLK_CGROUP_IOLATENCY is not <span class="built_in">set</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CONFIG_LATENCYTOP is not <span class="built_in">set</span></span></span><br></pre></td></tr></table></figure>



<p>latencytop - a tool for developers to visualize system latencies.</p>
<p>latencytop  is  a Linux* tool for software developers (both kernel and userspace), aimed at identifying where in the system latency is happening, and what kind of operation/action is causing the latency to happen so that the code can be changed to avoid the worst latency hiccups.</p>
<h4 id="3-7-opensnoop-bpfcc"><a href="#3-7-opensnoop-bpfcc" class="headerlink" title="3.7 opensnoop-bpfcc"></a>3.7 opensnoop-bpfcc</h4><p>opensnoop(8)8 is a BCC and bpftrace tool that traces file opens. It is useful for discovering the location of data files, log files, and configuration files.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">usage: opensnoop-bpfcc [-h] [-T] [-U] [-x] [-p PID] [-t TID] [-u UID] [-d DURATION] [-n NAME] [-e] [-f FLAG_FILTER]</span><br><span class="line"></span><br><span class="line">Trace open() syscalls</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help            show this help message and exit</span><br><span class="line">  -T, --timestamp       include timestamp on output</span><br><span class="line">  -U, --print-uid       print UID column</span><br><span class="line">  -x, --failed          only show failed opens</span><br><span class="line">  -p PID, --pid PID     trace this PID only</span><br><span class="line">  -t TID, --tid TID     trace this TID only</span><br><span class="line">  -u UID, --uid UID     trace this UID only</span><br><span class="line">  -d DURATION, --duration DURATION</span><br><span class="line">                        total duration of trace in seconds</span><br><span class="line">  -n NAME, --name NAME  only print process names containing this name</span><br><span class="line">  -e, --extended_fields</span><br><span class="line">                        show extended fields</span><br><span class="line">  -f FLAG_FILTER, --flag_filter FLAG_FILTER</span><br><span class="line">                        filter on flags argument (e.g., O_WRONLY)</span><br><span class="line"></span><br><span class="line">examples:</span><br><span class="line">    ./opensnoop           # trace all open() syscalls</span><br><span class="line">    ./opensnoop -T        # include timestamps</span><br><span class="line">    ./opensnoop -U        # include UID</span><br><span class="line">    ./opensnoop -x        # only show failed opens</span><br><span class="line">    ./opensnoop -p 181    # only trace PID 181</span><br><span class="line">    ./opensnoop -t 123    # only trace TID 123</span><br><span class="line">    ./opensnoop -u 1000   # only trace UID 1000</span><br><span class="line">    ./opensnoop -d 10     # trace for 10 seconds only</span><br><span class="line">    ./opensnoop -n main   # only print process names containing &quot;main&quot;</span><br><span class="line">    ./opensnoop -e        # show extended fields</span><br><span class="line">    ./opensnoop -f O_WRONLY -f O_RDWR  # only print calls for writing</span><br></pre></td></tr></table></figure>

<p>举例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# opensnoop-bpfcc -TU</span><br><span class="line">TIME(s)       UID   PID    COMM               FD ERR PATH</span><br><span class="line">0.000000000   1000  2080   sogouImeService    21   0 /proc</span><br><span class="line">0.001154000   1000  2080   sogouImeService    21   0 /proc/1/status</span><br><span class="line">0.001251000   1000  2080   sogouImeService    21   0 /proc/10/status</span><br><span class="line">0.001279000   1000  2080   sogouImeService    21   0 /proc/100/status</span><br><span class="line">0.001301000   1000  2080   sogouImeService    21   0 /proc/101/status</span><br><span class="line">0.001320000   1000  2080   sogouImeService    21   0 /proc/102/status</span><br><span class="line">0.001340000   1000  2080   sogouImeService    21   0 /proc/1024/status</span><br><span class="line">0.001362000   1000  2080   sogouImeService    21   0 /proc/103/status</span><br><span class="line">0.001382000   1000  2080   sogouImeService    21   0 /proc/104/status</span><br><span class="line">0.001400000   1000  2080   sogouImeService    21   0 /proc/105/status</span><br><span class="line">0.001419000   1000  2080   sogouImeService    21   0 /proc/106/status</span><br><span class="line">0.001439000   1000  2080   sogouImeService    21   0 /proc/1065/status</span><br><span class="line">0.001462000   1000  2080   sogouImeService    21   0 /proc/107/status</span><br><span class="line">0.001481000   1000  2080   sogouImeService    21   0 /proc/108/status</span><br><span class="line">0.001500000   1000  2080   sogouImeService    21   0 /proc/109/status</span><br><span class="line">0.001518000   1000  2080   sogouImeService    21   0 /proc/11/status</span><br><span class="line">0.001538000   1000  2080   sogouImeService    21   0 /proc/110/status</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>



<h4 id="3-8-filetop-bpfcc"><a href="#3-8-filetop-bpfcc" class="headerlink" title="3.8 filetop-bpfcc"></a>3.8 filetop-bpfcc</h4><p>filetop - File reads and writes by filename and process. Top for files.</p>
<p>统计显示最常被访问的文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">usage: filetop-bpfcc [-h] [-a] [-C] [-r MAXROWS] [-s &#123;all,reads,writes,rbytes,wbytes&#125;] [-p PID] [interval] [count]</span><br><span class="line"></span><br><span class="line">File reads and writes by process</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  interval              output interval, in seconds</span><br><span class="line">  count                 number of outputs</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help            show this help message and exit</span><br><span class="line">  -a, --all-files       include non-regular file types (sockets, FIFOs, etc)</span><br><span class="line">  -C, --noclear         don&#x27;t clear the screen</span><br><span class="line">  -r MAXROWS, --maxrows MAXROWS</span><br><span class="line">                        maximum rows to print, default 20</span><br><span class="line">  -s &#123;all,reads,writes,rbytes,wbytes&#125;, --sort &#123;all,reads,writes,rbytes,wbytes&#125;</span><br><span class="line">                        sort column, default rbytes</span><br><span class="line">  -p PID, --pid PID     trace this PID only</span><br><span class="line"></span><br><span class="line">examples:</span><br><span class="line">    ./filetop            # file I/O top, 1 second refresh</span><br><span class="line">    ./filetop -C         # don&#x27;t clear the screen</span><br><span class="line">    ./filetop -p 181     # PID 181 only</span><br><span class="line">    ./filetop 5          # 5 second summaries</span><br><span class="line">    ./filetop 5 10       # 5 second summaries, 10 times only</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# filetop-bpfcc -C</span><br><span class="line">Tracing... Output every 1 secs. Hit Ctrl-C to end</span><br><span class="line"></span><br><span class="line">15:58:01 loadavg: 0.11 0.06 0.07 1/533 13311</span><br><span class="line"></span><br><span class="line">TID    COMM             READS  WRITES R_Kb    W_Kb    T FILE</span><br><span class="line">13303  filetop-bpfcc    2      0      15      0       R loadavg</span><br><span class="line">13303  filetop-bpfcc    1      0      4       0       R retprobe</span><br><span class="line">13303  filetop-bpfcc    1      0      4       0       R type</span><br><span class="line">13303  filetop-bpfcc    2      0      1       0       R _bootlocale.cpython-38.pyc</span><br><span class="line"></span><br><span class="line">15:58:02 loadavg: 0.11 0.06 0.07 1/533 13311</span><br><span class="line"></span><br><span class="line">TID    COMM             READS  WRITES R_Kb    W_Kb    T FILE</span><br><span class="line">13303  filetop-bpfcc    2      0      15      0       R loadavg</span><br><span class="line"></span><br><span class="line">15:58:03 loadavg: 0.11 0.06 0.07 2/533 13319</span><br><span class="line"></span><br><span class="line">TID    COMM             READS  WRITES R_Kb    W_Kb    T FILE</span><br><span class="line">13316  ps               413    0      52859   0       R cmdline</span><br><span class="line">353    systemd-journal  4      0      8190    0       R cmdline</span><br><span class="line">2080   sogouImeService  183    0      2825    0       R status</span><br><span class="line">13313  pidof            582    0      2037    0       R stat</span><br><span class="line">13316  ps               297    0      588     0       R stat</span><br><span class="line">13316  ps               293    0      584     0       R status</span><br><span class="line">13313  pidof            385    0      385     0       R cmdline</span><br><span class="line">13316  ps               12     0      48      0       R passwd</span><br><span class="line">13303  filetop-bpfcc    2      0      15      0       R loadavg</span><br><span class="line">13316  ps               1      0      9       0       R drivers</span><br><span class="line">353    systemd-journal  6      0      8       0       R status</span><br><span class="line">13316  ps               2      0      8       0       R nsswitch.conf</span><br><span class="line">13318  grep             2      0      8       0       R locale.alias</span><br><span class="line">13316  ps               2      0      8       0       R Shanghai</span><br><span class="line">13316  ps               2      0      8       0       R locale.alias</span><br><span class="line">13317  grep             2      0      8       0       R locale.alias</span><br><span class="line">13316  ps               1      0      8       0       R online</span><br><span class="line">13316  ps               1      0      7       0       R meminfo</span><br><span class="line">13316  ps               1      0      7       0       R uptime</span><br><span class="line">353    systemd-journal  2      0      7       0       R current</span><br></pre></td></tr></table></figure>



<h4 id="3-9-cachestat-bpfcc"><a href="#3-9-cachestat-bpfcc" class="headerlink" title="3.9 cachestat-bpfcc"></a>3.9 cachestat-bpfcc</h4><p>cachestat(8)10 is a BCC tool that <strong>shows page cache hit and miss statistics</strong>. This can be used to <strong>check the hit ratio and efficiency of the page cache</strong>, and run while investigating system and application tuning for feedback on cache performance.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# cachestat-bpfcc -h</span><br><span class="line">usage: cachestat-bpfcc [-h] [-T] [interval] [count]</span><br><span class="line"></span><br><span class="line">Count cache kernel function calls</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  interval         output interval, in seconds</span><br><span class="line">  count            number of outputs</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help       show this help message and exit</span><br><span class="line">  -T, --timestamp  include timestamp on output</span><br></pre></td></tr></table></figure>



<p>举例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# cachestat-bpfcc -T</span><br><span class="line">TIME         HITS   MISSES  DIRTIES HITRATIO   BUFFERS_MB  CACHED_MB</span><br><span class="line">16:02:55     3533        0       36  100.00%           75        720</span><br><span class="line">16:02:56     1715       10       21   99.42%           75        720</span><br><span class="line">16:02:57       13        0        0  100.00%           75        720</span><br><span class="line">16:02:58     3466        0        1  100.00%           75        720</span><br><span class="line">16:02:59     1978        0        2  100.00%           75        720</span><br><span class="line">16:03:00        6        0        0  100.00%           75        720</span><br><span class="line">16:03:01     3482        0        1  100.00%           75        720</span><br><span class="line">16:03:02     1682        2        6   99.88%           75        720</span><br><span class="line">16:03:03        6        0        0  100.00%           75        720、</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>



<h4 id="3-10-ext4dist-bpfcc"><a href="#3-10-ext4dist-bpfcc" class="headerlink" title="3.10 ext4dist-bpfcc"></a>3.10 ext4dist-bpfcc</h4><p>ext4dist(8)11 is a BCC and bpftrace tool to instrument the ext4 file system and show the distribution of latencies as histograms for common operations: reads, writes, opens, and fsync. There are versions for other file systems: xfsdist(8), zfsdist(8), btrfsdist(8), and nfsdist(8).</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">usage: ext4dist-bpfcc [-h] [-T] [-m] [-p PID] [interval] [count]</span><br><span class="line"></span><br><span class="line">Summarize ext4 operation latency</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  interval            output interval, in seconds</span><br><span class="line">  count               number of outputs</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help          show this help message and exit</span><br><span class="line">  -T, --notimestamp   don&#x27;t include timestamp on interval output</span><br><span class="line">  -m, --milliseconds  output in milliseconds</span><br><span class="line">  -p PID, --pid PID   trace this PID only</span><br><span class="line"></span><br><span class="line">examples:</span><br><span class="line">    ./ext4dist            # show operation latency as a histogram</span><br><span class="line">    ./ext4dist -p 181     # trace PID 181 only</span><br><span class="line">    ./ext4dist 1 10       # print 1 second summaries, 10 times</span><br><span class="line">    ./ext4dist -m 5       # 5s summaries, milliseconds</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# ext4dist-bpfcc 1 1</span><br><span class="line">Tracing ext4 operation latency... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">16:05:29:</span><br><span class="line"></span><br><span class="line">operation = open</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 74       |****************************************|</span><br><span class="line">         2 -&gt; 3          : 2        |*                                       |</span><br><span class="line"></span><br><span class="line">operation = write</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 0        |                                        |</span><br><span class="line">         2 -&gt; 3          : 0        |                                        |</span><br><span class="line">         4 -&gt; 7          : 0        |                                        |</span><br><span class="line">         8 -&gt; 15         : 3        |****************************************|</span><br><span class="line"></span><br><span class="line">operation = read</span><br><span class="line">     usecs               : count     distribution</span><br><span class="line">         0 -&gt; 1          : 132      |****************************************|</span><br><span class="line">         2 -&gt; 3          : 2        |                                        |</span><br></pre></td></tr></table></figure>



<h4 id="3-11-ext4slower-bpfcc"><a href="#3-11-ext4slower-bpfcc" class="headerlink" title="3.11 ext4slower-bpfcc"></a>3.11 ext4slower-bpfcc</h4><p>This tool traces common ext4 file operations: reads, writes, opens, and syncs. It measures the time spent in these operations, and prints details for each that exceeded a threshold.</p>
<p>跟踪统计ext4文件操作比指定阈值要慢的操作。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">usage: ext4slower-bpfcc [-h] [-j] [-p PID] [min_ms]</span><br><span class="line"></span><br><span class="line">Trace common ext4 file operations slower than a threshold</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  min_ms             minimum I/O duration to trace, in ms (default 10)</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help         show this help message and exit</span><br><span class="line">  -j, --csv          just print fields: comma-separated values</span><br><span class="line">  -p PID, --pid PID  trace this PID only</span><br><span class="line"></span><br><span class="line">examples:</span><br><span class="line">    ./ext4slower             # trace operations slower than 10 ms (default)</span><br><span class="line">    ./ext4slower 1           # trace operations slower than 1 ms</span><br><span class="line">    ./ext4slower -j 1        # ... 1 ms, parsable output (csv)</span><br><span class="line">    ./ext4slower 0           # trace all operations (warning: verbose)</span><br><span class="line">    ./ext4slower -p 185      # trace PID 185 only</span><br></pre></td></tr></table></figure>



<h4 id="3-12-bpftrace"><a href="#3-12-bpftrace" class="headerlink" title="3.12 bpftrace"></a>3.12 bpftrace</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">Count write syscalls by syscall <span class="built_in">type</span>:</span></span><br><span class="line">bpftrace -e &#x27;tracepoint:syscalls:sys_enter_*write* &#123; @[probe] = count(); &#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Show the distribution of <span class="built_in">read</span>() syscall request sizes:</span></span><br><span class="line">bpftrace -e &#x27;tracepoint:syscalls:sys_enter_read &#123; @ = hist(args-&gt;count); &#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Show the distribution of <span class="built_in">read</span>() syscall <span class="built_in">read</span> bytes (and errors):</span></span><br><span class="line">bpftrace -e &#x27;tracepoint:syscalls:sys_exit_read &#123; @ = hist(args-&gt;ret); &#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Count <span class="built_in">read</span>() syscall errors by error code:</span></span><br><span class="line">bpftrace -e &#x27;t:syscalls:sys_exit_read /args-&gt;ret &lt; 0/ &#123; @[- args-&gt;ret] = count(); &#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Count VFS calls:</span></span><br><span class="line">bpftrace -e &#x27;kprobe:vfs_* &#123; @[probe] = count(); &#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Count VFS calls <span class="keyword">for</span> PID 181:</span></span><br><span class="line">bpftrace -e &#x27;kprobe:vfs_* /pid == 181/ &#123; @[probe] = count(); &#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Count ext4 tracepoints:</span></span><br><span class="line">bpftrace -e &#x27;tracepoint:ext4:* &#123; @[probe] = count(); &#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Count xfs tracepoints:</span></span><br><span class="line">bpftrace -e &#x27;tracepoint:xfs:* &#123; @[probe] = count(); &#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Count ext4 file reads by process name and user-level stack:</span></span><br><span class="line">bpftrace -e &#x27;kprobe:ext4_file_read_iter &#123; @[ustack, comm] = count(); &#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Trace ZFS spa_sync() <span class="built_in">times</span>:</span></span><br><span class="line">bpftrace -e &#x27;kprobe:spa_sync &#123; time(&quot;%H:%M:%S ZFS spa_sync()\n&quot;); &#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Count dcache references by process name and PID:</span></span><br><span class="line">bpftrace -e &#x27;kprobe:lookup_fast &#123; @[comm, pid] = count(); &#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>举例：</p>
<p>显示open()函数家族调用，打开的文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">bpftrace -e &#x27;t:syscalls:sys_enter_openat &#123; printf(&quot;%s %s\n&quot;, comm, str(args-&gt;filename)); &#125;&#x27;</span><br><span class="line"></span><br><span class="line">root@ubuntu:~# bpftrace -e &#x27;t:syscalls:sys_enter_openat &#123; printf(&quot;%s %s\n&quot;, comm, str(args-&gt;filename)); &#125;&#x27;</span><br><span class="line">Attaching 1 probe...</span><br><span class="line">vmtoolsd /proc/meminfo</span><br><span class="line">vmtoolsd /proc/vmstat</span><br><span class="line">vmtoolsd /proc/stat</span><br><span class="line">vmtoolsd /proc/zoneinfo</span><br><span class="line">vmtoolsd /proc/uptime</span><br><span class="line">vmtoolsd /proc/diskstats</span><br><span class="line">ps /etc/ld.so.cache</span><br><span class="line">ps /lib/x86_64-linux-gnu/libprocps.so.8</span><br><span class="line">ps /lib/x86_64-linux-gnu/libdl.so.2</span><br><span class="line">ps /lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">ps /lib/x86_64-linux-gnu/libsystemd.so.0</span><br><span class="line">ps /lib/x86_64-linux-gnu/librt.so.1</span><br><span class="line">ps /lib/x86_64-linux-gnu/liblzma.so.5</span><br><span class="line">ps /lib/x86_64-linux-gnu/liblz4.so.1</span><br><span class="line">ps /lib/x86_64-linux-gnu/libgcrypt.so.20</span><br><span class="line">ps /lib/x86_64-linux-gnu/libpthread.so.0</span><br><span class="line">ps /lib/x86_64-linux-gnu/libgpg-error.so.0</span><br><span class="line">ps /proc/self/auxv</span><br><span class="line">ps /proc/sys/kernel/osrelease</span><br><span class="line">ps /sys/devices/system/cpu/online</span><br><span class="line">ps /proc/self/auxv</span><br><span class="line">ps /usr/lib/locale/locale-archive</span><br><span class="line">ps /proc/self/stat</span><br><span class="line">ps /dev/tty</span><br><span class="line">ps /proc/uptime</span><br><span class="line">ps /usr/share/locale/locale.alias</span><br><span class="line">ps /usr/share/locale/en_US/LC_MESSAGES/procps-ng.mo</span><br><span class="line">ps /usr/share/locale/en/LC_MESSAGES/procps-ng.mo</span><br><span class="line">ps /usr/share/locale-langpack/en_US/LC_MESSAGES/procps-ng.mo</span><br><span class="line">ps /usr/share/locale-langpack/en/LC_MESSAGES/procps-ng.mo</span><br><span class="line">ps /proc/sys/kernel/pid_max</span><br><span class="line">ps /proc/sys/kernel/osrelease</span><br><span class="line">ps /proc/meminfo</span><br><span class="line">ps /proc</span><br><span class="line">ps /proc/1/stat</span><br><span class="line">ps /proc/1/status</span><br><span class="line">ps /etc/nsswitch.conf</span><br><span class="line">ps /etc/ld.so.cache</span><br><span class="line">ps /lib/x86_64-linux-gnu/libnss_files.so.2</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>



<h3 id="4-Disks"><a href="#4-Disks" class="headerlink" title="4. Disks"></a>4. Disks</h3><h4 id="4-1-iostat"><a href="#4-1-iostat" class="headerlink" title="4.1 iostat"></a>4.1 iostat</h4><p>iostat(1) summarizes per-disk I/O statistics, providing metrics for workload characterization, utilization, and saturation.</p>
<p>The name “iostat” is short for “I/O statistics”, although it might have been better to call it “diskiostat” to reflect the type of I/O it reports.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# iostat </span><br><span class="line">Linux 5.4.0-59-generic (ubuntu) 	2021年01月06日 	_x86_64_	(2 CPU)</span><br><span class="line"></span><br><span class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</span><br><span class="line">           0.96    0.07    1.04    0.57    0.00   97.37</span><br><span class="line"></span><br><span class="line">Device             tps    kB_read/s    kB_wrtn/s    kB_dscd/s    kB_read    kB_wrtn    kB_dscd</span><br><span class="line">loop0             0.01         0.06         0.00         0.00        338          0          0</span><br><span class="line">loop1             0.01         0.06         0.00         0.00        348          0          0</span><br><span class="line">loop10            0.00         0.00         0.00         0.00          8          0          0</span><br><span class="line">loop2             0.01         0.18         0.00         0.00       1063          0          0</span><br><span class="line">loop3             0.01         0.18         0.00         0.00       1072          0          0</span><br><span class="line">loop4             0.01         0.06         0.00         0.00        341          0          0</span><br><span class="line">loop5             0.01         0.18         0.00         0.00       1058          0          0</span><br><span class="line">loop6             0.01         0.06         0.00         0.00        342          0          0</span><br><span class="line">loop7             0.01         0.06         0.00         0.00        351          0          0</span><br><span class="line">loop8             0.01         0.06         0.00         0.00        336          0          0</span><br><span class="line">loop9             1.78         1.83         0.00         0.00      10784          0          0</span><br><span class="line">sda               7.13       174.03        41.48         0.00    1023155     243849          0</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>%user</td>
<td>CPU运行在用户态的百分比</td>
</tr>
<tr>
<td>%nice</td>
<td>CPU处在带NICE值的用户模式下的时间百分比</td>
</tr>
<tr>
<td>%system</td>
<td>CPU运行在内核态的百分比</td>
</tr>
<tr>
<td>%iowait</td>
<td>CPU等待输入输出完成时间的百分比</td>
</tr>
<tr>
<td>%steal</td>
<td>管理程序维护另一个虚拟处理器时，虚拟CPU的无意识等待时间百分比</td>
</tr>
<tr>
<td>%idle</td>
<td>CPU空闲时间百分比</td>
</tr>
<tr>
<td>tps</td>
<td>该设备每秒的传输次数（IOPS）</td>
</tr>
<tr>
<td>kB_read/s</td>
<td>每秒从设备（drive expressed）读取的数据量</td>
</tr>
<tr>
<td>kB_wrtn/s</td>
<td>每秒向设备（drive expressed）写入的数据量</td>
</tr>
<tr>
<td>kB_dscd/s</td>
<td>每秒设备丢弃的数据量</td>
</tr>
<tr>
<td>kB_read</td>
<td>读取的总数据量</td>
</tr>
<tr>
<td>kB_wrtn</td>
<td>写入的总数据量</td>
</tr>
<tr>
<td>kB_dscd</td>
<td>丢弃的总数据量</td>
</tr>
</tbody></table>
<p>如果%iowait的值过高，表示硬盘存在I/O瓶颈。</p>
<p>如果%idle值高，表示CPU较空闲。</p>
<p>如果%idle值高但系统响应慢时，可能是CPU等待分配内存，应加大内存容量。</p>
<p>如果%idle值持续低于10，表明CPU处理能力相对较低，系统中最需要解决的资源是CPU。</p>
<h4 id="4-2-PSI"><a href="#4-2-PSI" class="headerlink" title="4.2 PSI"></a>4.2 PSI</h4><p>io压力</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> cat /proc/pressure/io</span></span><br><span class="line">some avg10=63.11 avg60=32.18 avg300=8.62 total=667212021</span><br><span class="line">full avg10=60.76 avg60=31.13 avg300=8.35 total=622722632</span><br></pre></td></tr></table></figure>



<h4 id="4-3-pidstat"><a href="#4-3-pidstat" class="headerlink" title="4.3 pidstat"></a>4.3 pidstat</h4><p>The Linux pidstat(1) tool prints CPU usage by default and includes a -d option for disk I/O statistics.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# pidstat -d 2</span><br><span class="line">Linux 5.4.0-59-generic (ubuntu) 	2021年01月06日 	_x86_64_	(2 CPU)</span><br><span class="line"></span><br><span class="line">16时44分08秒   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command</span><br><span class="line"></span><br><span class="line">16时44分10秒   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command</span><br><span class="line"></span><br><span class="line">16时44分12秒   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command</span><br><span class="line">16时44分14秒     0       353      0.00     70.00      0.00       0  systemd-journal</span><br><span class="line"></span><br><span class="line">16时44分14秒   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command</span><br><span class="line">16时44分16秒     0       353      0.00     24.00      0.00       0  systemd-journal</span><br><span class="line"></span><br><span class="line">16时44分16秒   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command</span><br><span class="line">16时44分18秒     0       313      0.00      2.00      0.00       0  jbd2/sda5-8</span><br><span class="line">16时44分18秒     0       353      0.00      2.00      0.00       0  systemd-journal</span><br><span class="line"></span><br><span class="line">16时44分18秒   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command</span><br><span class="line">16时44分20秒   104       762      0.00      2.00      0.00       0  rsyslogd</span><br><span class="line"></span><br><span class="line">16时44分20秒   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command</span><br><span class="line"></span><br><span class="line">16时44分22秒   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command</span><br><span class="line">16时44分24秒     0       313      0.00      6.00      0.00       0  jbd2/sda5-8</span><br><span class="line">16时44分24秒     0       353      0.00      2.00      0.00       0  systemd-journal</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<p>其中，kB_ccwr/s的含义是：</p>
<p>Number of kilobytes whose writing to disk has been cancelled by the task. This may occur when the task truncates some dirty pagecache. In this case, some IO which another  task has been accounted for will not be happening.</p>
<h4 id="4-4-perf"><a href="#4-4-perf" class="headerlink" title="4.4 perf"></a>4.4 perf</h4><p>perf列出和block相关的事件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# perf list &#x27;block:*&#x27;</span><br><span class="line"></span><br><span class="line">List of pre-defined events (to be used in -e):</span><br><span class="line"></span><br><span class="line">  block:block_bio_backmerge                          [Tracepoint event]</span><br><span class="line">  block:block_bio_bounce                             [Tracepoint event]</span><br><span class="line">  block:block_bio_complete                           [Tracepoint event]</span><br><span class="line">  block:block_bio_frontmerge                         [Tracepoint event]</span><br><span class="line">  block:block_bio_queue                              [Tracepoint event]</span><br><span class="line">  block:block_bio_remap                              [Tracepoint event]</span><br><span class="line">  block:block_dirty_buffer                           [Tracepoint event]</span><br><span class="line">  block:block_getrq                                  [Tracepoint event]</span><br><span class="line">  block:block_plug                                   [Tracepoint event]</span><br><span class="line">  block:block_rq_complete                            [Tracepoint event]</span><br><span class="line">  block:block_rq_insert                              [Tracepoint event]</span><br><span class="line">  block:block_rq_issue                               [Tracepoint event]</span><br><span class="line">  block:block_rq_remap                               [Tracepoint event]</span><br><span class="line">  block:block_rq_requeue                             [Tracepoint event]</span><br><span class="line">  block:block_sleeprq                                [Tracepoint event]</span><br><span class="line">  block:block_split                                  [Tracepoint event]</span><br><span class="line">  block:block_touch_buffer                           [Tracepoint event]</span><br><span class="line">  block:block_unplug                                 [Tracepoint event]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Metric Groups:</span><br></pre></td></tr></table></figure>



<p><strong>磁盘I/O延时</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">perf record -e block:block_rq_issue,block:block_rq_complete -a sleep 20 </span><br><span class="line">perf script --header &gt; disk.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 这样得出分析文件，但还需在手动计算，比如用awk等工具对文本进行处理</span></span></span><br></pre></td></tr></table></figure>



<h4 id="4-5-biolatency-bpfcc"><a href="#4-5-biolatency-bpfcc" class="headerlink" title="4.5 biolatency-bpfcc"></a>4.5 biolatency-bpfcc</h4><p>这是直观的显示io latency的BCC工具。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">usage: biolatency-bpfcc [-h] [-T] [-Q] [-m] [-D] [-F] [interval] [count]</span><br><span class="line"></span><br><span class="line">Summarize block device I/O latency as a histogram</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  interval            output interval, in seconds</span><br><span class="line">  count               number of outputs</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help          show this help message and exit</span><br><span class="line">  -T, --timestamp     include timestamp on output</span><br><span class="line">  -Q, --queued        include OS queued time in I/O time</span><br><span class="line">  -m, --milliseconds  millisecond histogram</span><br><span class="line">  -D, --disks         print a histogram per disk device</span><br><span class="line">  -F, --flags         print a histogram per set of I/O flags</span><br><span class="line"></span><br><span class="line">examples:</span><br><span class="line">    ./biolatency            # summarize block I/O latency as a histogram</span><br><span class="line">    ./biolatency 1 10       # print 1 second summaries, 10 times</span><br><span class="line">    ./biolatency -mT 1      # 1s summaries, milliseconds, and timestamps</span><br><span class="line">    ./biolatency -Q         # include OS queued time in I/O time</span><br><span class="line">    ./biolatency -D         # show each disk device separately</span><br><span class="line">    ./biolatency -F         # show I/O flags separately</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/junixcn/images/master/image-20210106165353596.png" alt="image-20210106165353596"></p>
<p>-F选项可以根据flags分别显示io latency，这个选项很实用</p>
<p><img src="https://raw.githubusercontent.com/junixcn/images/master/image-20210106165552612.png" alt="image-20210106165552612"></p>
<h4 id="4-6-biosnoop-bpfcc"><a href="#4-6-biosnoop-bpfcc" class="headerlink" title="4.6 biosnoop-bpfcc"></a>4.6 biosnoop-bpfcc</h4><p>Trace all block device I/O and print a summary line per I/O</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">usage: biosnoop-bpfcc [-h] [-Q]</span><br><span class="line"></span><br><span class="line">Trace block I/O</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help   show this help message and exit</span><br><span class="line">  -Q, --queue  include OS queued time</span><br><span class="line"></span><br><span class="line">examples:</span><br><span class="line">    ./biosnoop           # trace all block I/O</span><br><span class="line">    ./biosnoop -Q        # include OS queued time</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test_mem# biosnoop-bpfcc -Q</span><br><span class="line">TIME(s)     COMM           PID    DISK    T SECTOR     BYTES  QUE(ms) LAT(ms)</span><br><span class="line">0.000000    ?              0              R 0          8         0.00    0.57</span><br><span class="line">2.017184    ?              0              R 0          8         0.00    1.44</span><br><span class="line">3.168129    jbd2/sda5-8    313    sda     W 206940176  16384     0.00    0.18</span><br><span class="line">3.168304    jbd2/sda5-8    313    sda     W 206940208  4096      0.00    0.13</span><br><span class="line">4.031720    ?              0              R 0          8         0.00    0.31</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>



<h4 id="4-7-biostack-bt"><a href="#4-7-biostack-bt" class="headerlink" title="4.7 biostack.bt"></a>4.7 biostack.bt</h4><p>biostacks(8)14 is a bpftrace tool that traces the block I/O request time (from OS enqueue to device completion) with the I/O initialization stack trace.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test_mem# biostacks.bt </span><br><span class="line">Attaching 5 probes...</span><br><span class="line">cannot attach kprobe, probe entry may not exist</span><br><span class="line">Warning: could not attach probe kprobe:blk_start_request, skipping.</span><br><span class="line">Tracing block I/O with init stacks. Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@usecs[</span><br><span class="line">    blk_account_io_start+1</span><br><span class="line">    generic_make_request+207</span><br><span class="line">    submit_bio+72</span><br><span class="line">    submit_bh_wbc+386</span><br><span class="line">    submit_bh+19</span><br><span class="line">    journal_submit_commit_record.part.0+475</span><br><span class="line">    jbd2_journal_commit_transaction+4754</span><br><span class="line">    kjournald2+182</span><br><span class="line">    kthread+260</span><br><span class="line">    ret_from_fork+53</span><br><span class="line">]: </span><br><span class="line">[4K, 8K)               1 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@usecs[</span><br><span class="line">    blk_account_io_start+1</span><br><span class="line">    blk_attempt_plug_merge+274</span><br><span class="line">    blk_mq_make_request+863</span><br><span class="line">    generic_make_request+207</span><br><span class="line">    submit_bio+72</span><br><span class="line">    submit_bh_wbc+386</span><br><span class="line">    submit_bh+19</span><br><span class="line">    jbd2_journal_commit_transaction+1484</span><br><span class="line">    kjournald2+182</span><br><span class="line">    kthread+260</span><br><span class="line">    ret_from_fork+53</span><br><span class="line">]: </span><br><span class="line">[4K, 8K)               1 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>



<h4 id="4-8-blktrace"><a href="#4-8-blktrace" class="headerlink" title="4.8 blktrace"></a>4.8 blktrace</h4><p>blktrace - generate traces of the i/o traffic on block devices.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]#  blktrace -d /dev/sdc1 -o - | blkparse -i -</span><br><span class="line">  8,32   4        1     0.000000000 1385858  A   W 3470177952 + 8 &lt;- (8,33) 3470175904</span><br><span class="line">  8,33   4        2     0.000000992 1385858  Q   W 3470177952 + 8 [kworker/u113:3]</span><br><span class="line">  8,33   4        3     0.000007305 1385858  G   W 3470177952 + 8 [kworker/u113:3]</span><br><span class="line">  8,33   4        4     0.000008454 1385858  P   N [kworker/u113:3]</span><br><span class="line">  8,32   4        5     0.000015076 1385858  A   W 9638099512 + 8 &lt;- (8,33) 9638097464</span><br><span class="line">  8,33   4        6     0.000015273 1385858  Q   W 9638099512 + 8 [kworker/u113:3]</span><br><span class="line">  8,33   4        7     0.000016198 1385858  G   W 9638099512 + 8 [kworker/u113:3]</span><br><span class="line">  8,32   4        8     0.000027067 1385858  A  WM 3036678400 + 8 &lt;- (8,33) 3036676352</span><br><span class="line">  8,33   4        9     0.000027267 1385858  Q  WM 3036678400 + 8 [kworker/u113:3]</span><br><span class="line">  8,33   4       10     0.000028193 1385858  G  WM 3036678400 + 8 [kworker/u113:3]</span><br><span class="line">  8,32   4       11     0.000033291 1385858  A   W 302800272 + 8 &lt;- (8,33) 302798224</span><br><span class="line">  8,33   4       12     0.000033485 1385858  Q   W 302800272 + 8 [kworker/u113:3]</span><br><span class="line">  8,33   4       13     0.000034269 1385858  G   W 302800272 + 8 [kworker/u113:3]</span><br><span class="line">  8,33   4       14     0.000035653 1385858  U   N [kworker/u113:3] 4</span><br><span class="line">  8,33   4       15     0.000036376 1385858  I   W 3470177952 + 8 [kworker/u113:3]</span><br><span class="line">  8,33   4       16     0.000036877 1385858  I   W 9638099512 + 8 [kworker/u113:3]</span><br><span class="line">  8,33   4       17     0.000037129 1385858  I  WM 3036678400 + 8 [kworker/u113:3]</span><br><span class="line">  8,33   4       18     0.000037273 1385858  I   W 302800272 + 8 [kworker/u113:3]</span><br><span class="line">  8,33   4       19     0.000042762 1385858  D   W 3470177952 + 8 [kworker/u113:3]</span><br><span class="line">  8,33   4       20     0.000050812 1385858  D   W 9638099512 + 8 [kworker/u113:3]</span><br><span class="line">  8,33   4       21     0.000052794 1385858  D  WM 3036678400 + 8 [kworker/u113:3]</span><br><span class="line">  8,33   4       22     0.000054746 1385858  D   W 302800272 + 8 [kworker/u113:3]</span><br><span class="line">  8,33  12        1     0.000427923     0  C   W 302800272 + 8 [0]</span><br><span class="line">  8,33  12        2     0.000438597     0  C  WM 3036678400 + 8 [0]</span><br><span class="line">  8,33  12        3     0.000441113     0  C   W 3470177952 + 8 [0]</span><br><span class="line">  8,33  12        4     0.000443239     0  C   W 9638099512 + 8 [0]</span><br><span class="line">^CCPU4 (8,33):</span><br><span class="line"> Reads Queued:           0,        0KiB  Writes Queued:           4,       16KiB</span><br><span class="line"> Read Dispatches:        0,        0KiB  Write Dispatches:        4,       16KiB</span><br><span class="line"> Reads Requeued:         0               Writes Requeued:         0</span><br><span class="line"> Reads Completed:        0,        0KiB  Writes Completed:        0,        0KiB</span><br><span class="line"> Read Merges:            0,        0KiB  Write Merges:            0,        0KiB</span><br><span class="line"> Read depth:             0               Write depth:             4</span><br><span class="line"> IO unplugs:             1               Timer unplugs:           0</span><br><span class="line">CPU12 (8,33):</span><br><span class="line"> Reads Queued:           0,        0KiB  Writes Queued:           0,        0KiB</span><br><span class="line"> Read Dispatches:        0,        0KiB  Write Dispatches:        0,        0KiB</span><br><span class="line"> Reads Requeued:         0               Writes Requeued:         0</span><br><span class="line"> Reads Completed:        0,        0KiB  Writes Completed:        4,       16KiB</span><br><span class="line"> Read Merges:            0,        0KiB  Write Merges:            0,        0KiB</span><br><span class="line"> Read depth:             0               Write depth:             4</span><br><span class="line"> IO unplugs:             0               Timer unplugs:           0</span><br><span class="line"></span><br><span class="line">Total (8,33):</span><br><span class="line"> Reads Queued:           0,        0KiB  Writes Queued:           4,       16KiB</span><br><span class="line"> Read Dispatches:        0,        0KiB  Write Dispatches:        4,       16KiB</span><br><span class="line"> Reads Requeued:         0               Writes Requeued:         0</span><br><span class="line"> Reads Completed:        0,        0KiB  Writes Completed:        4,       16KiB</span><br><span class="line"> Read Merges:            0,        0KiB  Write Merges:            0,        0KiB</span><br><span class="line"> IO unplugs:             1               Timer unplugs:           0</span><br><span class="line"></span><br><span class="line">Throughput (R/W): 0KiB/s / 0KiB/s</span><br><span class="line">Events (8,33): 26 entries</span><br><span class="line">Skips: 0 forward (0 -   0.0%)</span><br></pre></td></tr></table></figure>



<h4 id="4-9-bpftrace"><a href="#4-9-bpftrace" class="headerlink" title="4.9 bpftrace"></a>4.9 bpftrace</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">Count block I/O tracepoints events:</span></span><br><span class="line">bpftrace -e &#x27;tracepoint:block:* &#123; @[probe] = count(); &#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Summarize block I/O size as a histogram:</span></span><br><span class="line">bpftrace -e &#x27;t:block:block_rq_issue &#123; @bytes = hist(args-&gt;bytes); &#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Count block I/O request user stack traces:</span></span><br><span class="line">bpftrace -e &#x27;t:block:block_rq_issue &#123; @[ustack] = count(); &#125;&#x27;</span><br><span class="line">bpftrace -e &#x27;t:block:block_rq_insert &#123; @[ustack] = count(); &#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Count block I/O <span class="built_in">type</span> flags:</span></span><br><span class="line">bpftrace -e &#x27;t:block:block_rq_issue &#123; @[args-&gt;rwbs] = count(); &#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Trace block I/O errors with device and I/O <span class="built_in">type</span>:</span></span><br><span class="line">bpftrace -e &#x27;t:block:block_rq_complete /args-&gt;error/ &#123; printf(&quot;dev %d type %s error %d\n&quot;, args-&gt;dev, args-&gt;rwbs, args-&gt;error); &#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Count SCSI opcodes:</span></span><br><span class="line">bpftrace -e &#x27;t:scsi:scsi_dispatch_cmd_start &#123; @opcode[args-&gt;opcode] = count(); &#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Count SCSI result codes:</span></span><br><span class="line">bpftrace -e &#x27;t:scsi:scsi_dispatch_cmd_done &#123; @result[args-&gt;result] = count(); &#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Count SCSI driver <span class="built_in">functions</span>:</span></span><br><span class="line">bpftrace -e &#x27;kprobe:scsi* &#123; @[func] = count(); &#125;&#x27;</span><br></pre></td></tr></table></figure>



<h3 id="perf-ftrace-BPF需要深入研究"><a href="#perf-ftrace-BPF需要深入研究" class="headerlink" title="perf/ftrace/BPF需要深入研究"></a>perf/ftrace/BPF需要深入研究</h3>
    </div>
</div>
<style>
    #noneimg img {
        display: none;
        z-index: 109;
        width: 600px !important;
        border-radius: 0px;
        position: fixed;
        box-shadow: 0 0 0px #c3c3c300 !important;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        margin: auto !important;
    }

    @media screen and (max-width:600px) {
        #noneimg img {
            width: 88%
        }
    }
</style>
<script>
    $(function () { $('#article').click(function (e) { if (e.target.tagName == "IMG") { if ($('#nonediv').length == 0) { let MImg = `<div id='noneimg'><img src='${e.target.currentSrc}'></div>`; let MDiv = "<div id='nonediv' style='cursor: pointer;display: none; position: fixed;left: 0;top: 0; right: 0;bottom: 0;background-color: #333;opacity:0.5;z-index: 108;'></div>"; $('#article').append(MDiv); $('#article').append(MImg); $("#nonediv").fadeIn("slow"); $("#noneimg img").fadeIn("slow") } } else { if ($('#nonediv').length !== 0) { $("#noneimg ").fadeOut("slow"); $("#nonediv").fadeOut("slow"); setTimeout(function () { $('#nonediv').remove(); $('#noneimg').remove() }, 500) } } }); $('.article-content').addClass('content-move') });
</script>
<div class="Last-Next">
    

    
    <a href="/2021/01/05/2021-01-05-system-performance/">
        <div class="next">
            <span>下一篇</span>
            <p>System-Performance Notes</p>
        </div>
    </a>
    
</div>
		
<link rel="stylesheet" href="/css/food.css">

<div class="footer">
	<div class="Copyright">
		©2021 By Junixcn.   Repository : <a
			style="text-decoration: none;display: contents; color: #898F9F;"
			target="_blank" rel="noopener" href="https://github.com/junixcn/junixcn.github.io.git">junixcn</a>
	</div>
	<div class="contact">
		
		<a target="_blank" rel="noopener" href="https://github.com/junixcn">
			<img src="/image/github-logo.png" alt="Quiet主题">
		</a>
		
	</div>
</div>

<script src="/js/jquery.min.js"></script>


<script src="/js/gotop.js"></script>


<style type="text/css">
    @media screen and (min-width: 600px) {
        .goTop>span {
            display: block;
            border-radius: 50%;
            width: 66px;
            height: 66px;
            cursor: pointer;
            opacity: 0.8;
            background: rgba(18, 24, 58, 0.06);
            text-align: center;
            border: 1px solid rgba(18, 24, 58, 0.06);

            transition: border .5s;
            -moz-transition: border .5s;
            /* Firefox 4 */
            -webkit-transition: border .5s;
            /* Safari 和 Chrome */
            -o-transition: border .5s;
            /* Opera */
        }

        .goTop>span:hover {
            border: 1px solid #6680B3;
        }


        .goTop {
            position: fixed;
            right: 30px;
            bottom: 80px;
        }

        .goTop>span>svg {
            width: 30px;
            height: 30px;
            margin-top: 17.5px;
            opacity: 0.7;
        }

    }

    @media screen and (max-width: 600px) {
        .goTop {
            display: none;
        }
    }
</style>
<div class="goTop" id="js-go_top">
    <span>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
            <g>
                <path d="M13 12v8h-2v-8H4l8-8 8 8z"></path>
            </g>
        </svg>
    </span>
</div>
<script>
    $('#js-go_top').gotoTop({ offset: 500, speed: 300, animationShow: { 'transform': 'translate(0,0)', 'transition': 'transform .5s ease-in-out' }, animationHide: { 'transform': 'translate(100px,0)', 'transition': 'transform .5s ease-in-out' } });
</script>
<script>
	console.log('\n %c Hexo-Quiet 主题 %c https://github.com/QiaoBug/hexo-theme-quiet \n', 'color: #fadfa3; background: #030307; padding:5px 0;', 'background: #fadfa3; padding:5px 0;')
</script>

	</body>

</html>